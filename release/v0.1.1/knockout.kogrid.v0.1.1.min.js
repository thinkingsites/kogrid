/*
kogrid - created by Miguel Ludert
https://github.com/thinkingsites/kogrid

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
"use strict";(function(){var e=function(e,t){var n=_.debounce,s=t.isObservable,i=(t.bindingHanders,_.extend),a=t.observable,o=window,r=_.each,d=_.isFunction,l=_.isNumber,c=_.isString,g=_.map,u=_.find,p=function(){},f=function(e){return function(){return this}.bind(e)},h=function(e){return s(e)?e:a(e)},b=function(e){return s(e)?e():e},v=function(e){return s(e)?e.peek():e},k=a({h:e(o).height(),w:e(o).width()}),m=function(){return"ko-grid-"+(""+Math.round(Math.random()*Math.pow(10,10)))},x=function(t,n,s){var i=$[n],a=e(i.template).appendTo(t);return i.cssClass&&a.addClass(i.cssClass),s&&a.css(s),a},w=function(t){if(t.addjQueryUiSortingIcons!==!1){var n=["ui-icon","ui-icon-triangle-2-n-s","ui-icon-triangle-1-n","ui-icon ui-icon-triangle-1-s"],s=t.addjQueryUiSortingIcons===!0,i=e.ui||_.any(document.styleSheets,function(e){return _(e.rules).map(function(e){return e.selectorText.slice(1)}).intersection(jquiStyles).value().length==n.length});(s||i)&&(t.sorting.noSortClass+=[void 0,n[0],n[1]].join(" "),t.sorting.ascendingClass+=[void 0,n[0],n[2]].join(" "),t.sorting.descendingClass+=[void 0,n[0],n[3]].join(" "))}},C=function(t,n){var s=e(t),n=parseInt(n)||n,i=e("."+$.scrollContainer.cssClass,s),a=e("."+$.headContainer.cssClass,s).outerHeight(),o=e("."+$.pager.cssClass,s).outerHeight();s.css("height",n),"auto"!==n&&"inherit"!==n?i.css("height",s.innerHeight()-a-o):i.css("height",n)},y=function(o,r,f){var m,x=this,w=t.observableArray();if(i(x,I,o),x.templates={},x.element=r,x.classes=f,x.rows=h(x.rows),x.height=h(x.height),x.total=h(x.total),x.pageSize=h(x.pageSize),x.pageIndex=h(x.pageIndex),x.url=h(x.url),x.isString=c,x.any=function(){var e=b(x.rows);return!(_.isUndefined(e)||0==e.length)},x.resizeHeaders=function(){var t,n,s=e("."+x.classes.head,x.element),i=e("."+x.classes.row+":first ."+x.classes.cell,x.element).map(function(){var t=e(this);return{left:t.position().left,width:t.width()}});if(s.length!=i.length)return s.css({position:"relative",top:0,left:"auto",width:Math.floor(100/s.length)+"%"}).width(),void 0;s.first().parent().height(s.first().height());for(var a=0;s.length>a;a++)t=s.eq(a),n=i[a],t.css({position:"absolute",top:0,left:n.left-1,width:n.width})},x.afterRender=n(function(){x.resizeHeaders(),C(x.element,x.height.peek()),d(x.done)&&x.done(r)},10),x.sort=function(){if(this.sortable===!0){var e=this,t=u(w.peek(),function(t){return t.key===e.key})||{key:e.key,direction:e.direction},n=_.filter(w.peek(),function(t){return t.key!=e.key});t.direction=t.direction===x.sorting.asc?x.sorting.desc:x.sorting.asc,x.sorting.allowMultiSort?(n.unshift(t),w(n)):w([t]),s(e.direction)?e.direction(t.direction):e.direction=t.direction,d(x.refresh)?x.refresh():s(x.rows)}},x.sortClass=function(e){var t=u(w(),function(t){return t.key===e.key});if(t){if(t.direction==x.sorting.asc)return x.sorting.ascendingClass;if(t.direction==x.sorting.desc)return x.sorting.descendingClass}return x.sorting.noSortClass},s(x.total)||(x.total=t.computed({read:function(){return l(m)?m:s(x.rows)?x.rows.peek().length:_.isArray(x.rows)?x.rows.length:void 0},write:function(e){m=e}})),x.totalPages=t.computed(function(){var e=x.total(),t=x.pageSize();return l(e)&&l(t)?Math.ceil(e/t):1}),x.first=function(){x.pageIndex(1)},x.previous=function(){var e=x.pageIndex.peek();x.pageIndex(Math.max(1,e-1))},x.next=function(){var e=x.pageIndex.peek(),t=x.totalPages.peek();x.pageIndex(Math.min(t,e+1))},x.last=function(){x.pageIndex(x.totalPages.peek())},x.goToPage=function(){var e=parseInt(x.goToPageText.peek());l(e)&&e>=1&&x.totalPages.peek()>=e?x.pageIndex(e):x.goToPageText("")},x.goToPageText=a(),k.subscribe(x.resizeHeaders),function y(e){_.forOwn(e,function(e){var t=e;s(t)&&(t.subscribe(function(){x.afterRender()}),t=t()),_.isObject(t)&&y(t)})}(o),c(x.url.peek()))x.rows=h(x.rows),x.refresh=function(){d(x.loading)&&x.loading(x.element,x.rows.peek());var t=x.pageIndex.peek(),n=x.pageSize.peek(),s=l(n)?{pageIndex:t,pageSize:n}:{pageIndex:1},a=v(x.data),o={};return o[x.sorting.sortColumn]=g(w.peek(),function(e){return e.key}),o[x.sorting.sortDirection]=g(w.peek(),function(e){return e.direction}),e.ajax({url:x.url.peek(),data:i(s,o,a),type:x.type||"get",dataType:x.dataType||"json"}).done(function(e){x.rows(e.rows),x.total(e.total||e.rows.length)}).always(function(){d(x.loaded)&&x.loaded(x.element,x.rows.peek())}).promise()},s(x.data)&&x.data.subscribe(x.refresh),x.url.subscribe(x.refresh),x.refresh();else{x.refresh=p;var $=h(x.rows);x.rows=t.computed({read:function(){var e=x.pageSize(),t=(x.pageIndex()-1)*e;return $().slice(t,t+e)},write:function(e){$(e)}}),x.total($.peek().length)}x.pageIndex.subscribe(x.refresh),x.pageSize.subscribe(function(){var e=x.totalPages.peek(),t=x.pageIndex.peek();t>e?x.pageIndex(e):x.refresh()}),x.height.subscribe(function(e){C(x.element,e)}),x.isColumnVisible=function(e){return e=e||this,s(e.visible)||_.isBoolean(e.visible)?e.visible:!0}},I={pageSize:25,pageSizeOptions:[10,25,50,100,200,"All"],pageIndex:1,pager:!0,height:"auto",loading:function(t){e("table",t).css({opacity:.5})},loaded:function(t){e("table",t).css({opacity:1})},noRowsText:"No rows available",sorting:{allowMultiSort:!1,sortColumn:"sortColumn",sortDirection:"sortDirection",asc:"asc",desc:"desc",noSortClass:"ko-grid-sort-none",ascendingClass:"ko-grid-sort-asc",descendingClass:"ko-grid-sort-desc",addjQueryUiSortingIcons:"auto"}},$={headContainer:{template:"<div data-bind='foreach : { data : columns, afterRender : $root.afterRender }'></div>",cssClass:"ko-grid-head-container"},head:{template:"<div data-bind='visible : $root.isColumnVisible($data), click : $root.sort, css : { \"ko-grid-is-sortable\" : $data.sortable } '><span data-bind='text : ($root.isString($data) ? $data : $data.title)'></span></div>",cssClass:"ko-grid-head"},sortIcon:{template:"<span type='button' data-bind='visible: $data.sortable,  css : $root.sortClass($data) '>Sort</span>",cssClass:"ko-grid-sort-icon"},scrollContainer:{template:"<div></div>",cssClass:"ko-grid-scroll-container"},table:{template:"<table cellspacing='0' cellpadding='0' data-bind='visible : any'><tbody data-bind='foreach : { data : rows, afterRender : $root.afterRender }'></tbody></table>",cssClass:"ko-grid-table"},row:{template:'<tr data-bind=\'foreach : $root.columns, css : $index()%2 ? $root.classes.row + "-even" : $root.classes.row + "-odd" \'></tr>',cssClass:"ko-grid-row"},cell:{template:"<td data-bind='kogrid$cell:$data'></td>",cssClass:"ko-grid-cell"},pager:{template:"<div></div>",cssClass:"ko-grid-pager"},first:{template:"<button type='button' data-bind='click : first, disable : pageIndex() == 1' title='First'>&lt;&lt; First</button>",cssClass:"ko-grid-first"},previous:{template:"<button type='button' data-bind='click : previous, disable : pageIndex() == 1' title='Previous'>&lt; Previous</button>",cssClass:"ko-grid-previous"},next:{template:"<button type='button' data-bind='click : next, disable : pageIndex() == totalPages()' title='Next'>Next &gt;</button>",cssClass:"ko-grid-next"},last:{template:"<button type='button' data-bind='click : last, disable : pageIndex() == totalPages()' title='Last'>Last  &gt;&gt;</button>",cssClass:"ko-grid-last"},refresh:{template:"<button type='button' data-bind='click : refresh' title='Refresh'>Refresh</button>",cssClass:"ko-grid-refresh"},pageSize:{template:"<select data-bind='options : pageSizeOptions, value : pageSize'></select>",cssClass:"ko-grid-page-size"},goToPage:{template:"<div><input type='text' data-bind='value : goToPageText'><button data-bind='click : goToPage'>Go</button></div>",cssClass:"ko-grid-go-to-page"},pagingText:{template:"<div>Page <span data-bind='text:pageIndex'></span> of <span data-bind='text: totalPages'></span></div>",cssClass:"ko-grid-paging-text"},totalText:{template:"<div><span data-bind='text:total'></span> records</div>",cssClass:"ko-grid-total-text"},noRows:{template:"<div data-bind='visible : !any(), text : $root.noRowsText'></div>",cssClass:"ko-grid-no-rows"}};e(function(){e(o).on("resize",n(function(){var t={h:e(o).height(),w:e(o).width()},n=k.peek();(t.h!==n.h||t.w!==n.w)&&k(t)},100))});var S={kogrid$cell:{init:function(e,n,s,a,o){var r=o.$root,l=o.$parent,g=o.$data,u=r.templates[g.template],p={visible:r.isColumnVisible.bind(g)};if(u)p.template=f({name:u,data:i({},g.data,l)});else{var h,b=c(g)?g:g.key,v=l[b],h=d(v)?v():v;p.text=f(h)}return i(p,{style:f(g.style),css:f(g.css)}),t.applyBindingAccessorsToNode(e,p,o.extend({$columnIndex:f(o.$index()),$rowIndex:f(o.$parentContext.$index())})),{controlsDescendantBindings:!0}}},kogrid:{init:function(n,a){return e(function(){var o,d=function(){var e={};return r($,function(t,n){e[n]=t.cssClass}),e}(),l=a(),g=new y(l,n,d),u=s(g.columns)?g.columns.peek():g.columns,f=e(n).addClass("ko-grid-main").css({height:g.height.peek()}),h=x(f,"headContainer",{position:"relative"}),b=x(h,"head"),v=(x(b,"sortIcon"),x(f,"scrollContainer")),k=x(v,"noRows"),k=x(v,"table",{position:"relative"}),C=x(k,"row");x(C,"cell"),g.pager&&(o=x(f,"pager"),g.refresh!==p&&x(o,"refresh"),x(o,"first"),x(o,"previous"),x(o,"pagingText"),x(o,"next"),x(o,"last"),x(o,"pageSize"),x(o,"goToPage"),x(o,"totalText")),_(u).filter(function(e){return c(e.template)}).each(function(t){if(!_.isElement(document.getElementById(t.template))){var s=m();g.templates[t.template]=s,e("<script type='text/html' id='"+s+"'>"+t.template+"</script>").appendTo(n)}}),w(g),t.applyBindingsToDescendants(g,n),l.utils=i({},l.utils,{fixHeaders:g.resizeHeaders,refresh:g.refresh,goToPage:function(e){self.pageIndex(e)}})}),{controlsDescendantBindings:!0}},options:I,templates:$}};i(t.bindingHandlers,S)};"undefined"!=typeof ko&&ko.observable&&e(jQuery,ko,_),"undefined"!=typeof define&&define.amd&&define(["jquery","knockout","_"],e)})();