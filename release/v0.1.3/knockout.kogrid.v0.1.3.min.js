/*
kogrid - created by Miguel Ludert
https://github.com/thinkingsites/kogrid

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
"use strict";(function(){var e=function(e,t){var n=_.debounce,i=t.isObservable,s=(t.bindingHanders,t.observable),a=t.computed,o=t.applyBindingAccessorsToNode||function(e,n,i){var s={};return _.each(n,function(e,t){s[t]=e()}),t.applyBindingsToNode(e,s,i)},r=function(e){return _.isString(e)&&document.getElementById(e)||_.isElement(e)},l=_.extend,d=window,c=_.each,u=_.isFunction,g=_.isNumber,p=_.isString,f=_.map,h=_.find,b=function(){},v=function(e){return function(){return this}.bind(e)},k=function(e){return i(e)?e:s(e)},m=function(e){return i(e)?e():e},x=function(e){return i(e)?e.peek():e},w=s({h:e(d).height(),w:e(d).width()}),C=function(){return"ko-grid-"+(""+Math.round(Math.random()*Math.pow(10,10)))},y=function(t,n,i){var s=P[n],a=e(s.template).appendTo(t);return s.cssClass&&a.addClass(s.cssClass),i&&a.css(i),a},I=function(t){if(t.addjQueryUiSortingIcons!==!1){var n=["ui-icon","ui-icon-triangle-2-n-s","ui-icon-triangle-1-n","ui-icon ui-icon-triangle-1-s"],i=t.addjQueryUiSortingIcons===!0,s=e.ui||_.any(document.styleSheets,function(e){return _(e.rules).filter(function(e){return e.selectorText}).map(function(e){return e.selectorText.slice(1)}).intersection(n).value().length==n.length});(i||s)&&(t.sorting.noSortClass+=[void 0,n[0],n[1]].join(" "),t.sorting.ascendingClass+=[void 0,n[0],n[2]].join(" "),t.sorting.descendingClass+=[void 0,n[0],n[3]].join(" "))}},$=function(t,n){var i=e(t),n=parseInt(n)||n,s=e("."+P.scrollContainer.cssClass,i),a=e("."+P.headContainer.cssClass,i).outerHeight(),o=e("."+P.pager.cssClass,i).outerHeight();i.css("height",n),"auto"!==n&&"inherit"!==n?s.css("height",i.innerHeight()-a-o):s.css("height",n)},S=function(o,r,d){var c,v=this,C=t.observableArray();if(l(v,T,o),v.templates={},v.element=r,v.classes=d,v.rows=k(v.rows),v.height=k(v.height),v.total=k(v.total),v.pageSize=k(v.pageSize),v.pageIndex=k(v.pageIndex),v.url=k(v.url),v.rowClick=function(e,t){var n=this;n&&n.call(e,e,t)}.bind(v.rowClick),v.isString=p,v.any=a(function(){var e=m(v.rows);return!(_.isUndefined(e)||0==e.length)}),v.none=a(function(){var e=m(v.rows);return _.isUndefined(e)||0==e.length}),v.resizeHeaders=function(){var t,n,i=e("."+v.classes.head,v.element),s=e("."+v.classes.row+":first ."+v.classes.cell,v.element).map(function(){var t=e(this);return{left:t.position().left,width:t.width()}});if(i.length!=s.length)return i.css({position:"relative",top:0,left:"auto",width:Math.floor(100/i.length)+"%"}).width(),void 0;i.first().parent().height(i.first().height());for(var a=0;i.length>a;a++)t=i.eq(a),n=s[a],t.css({position:"absolute",top:0,left:n.left-1,width:n.width})},v.afterRender=n(function(){v.resizeHeaders(),$(v.element,v.height.peek()),u(v.done)&&v.done(r)},10),v.sort=function(){if(this.sortable===!0){var e=this,t=h(C.peek(),function(t){return t.key===e.key})||{key:e.key,direction:e.direction},n=_.filter(C.peek(),function(t){return t.key!=e.key});t.direction=t.direction===v.sorting.asc?v.sorting.desc:v.sorting.asc,v.sorting.allowMultiSort?(n.unshift(t),C(n)):C([t]),i(e.direction)?e.direction(t.direction):e.direction=t.direction,u(v.refresh)?v.refresh():i(v.rows)}},v.sortClass=function(e){var t=h(C(),function(t){return t.key===e.key});if(t){if(t.direction==v.sorting.asc)return v.sorting.ascendingClass;if(t.direction==v.sorting.desc)return v.sorting.descendingClass}return v.sorting.noSortClass},i(v.total)||(v.total=a({read:function(){return g(c)?c:i(v.rows)?v.rows.peek().length:_.isArray(v.rows)?v.rows.length:void 0},write:function(e){c=e}})),v.totalPages=a(function(){var e=v.total(),t=v.pageSize();return g(e)&&g(t)?Math.ceil(e/t):1}),v.first=function(){v.pageIndex(1)},v.previous=function(){var e=v.pageIndex.peek();v.pageIndex(Math.max(1,e-1))},v.next=function(){var e=v.pageIndex.peek(),t=v.totalPages.peek();v.pageIndex(Math.min(t,e+1))},v.last=function(){v.pageIndex(v.totalPages.peek())},v.goToPage=function(){var e=parseInt(v.goToPageText.peek());g(e)&&e>=1&&v.totalPages.peek()>=e?v.pageIndex(e):v.goToPageText("")},v.goToPageText=s(),w.subscribe(v.resizeHeaders),function y(e){_.forOwn(e,function(e){var t=e;i(t)&&(t.subscribe(function(){v.afterRender()}),t=t()),_.isObject(t)&&y(t)})}(o),p(v.url.peek()))v.rows=k(v.rows),v.refresh=function(){u(v.loading)&&v.loading(v.element,v.rows.peek());var t=v.pageIndex.peek(),n=v.pageSize.peek(),i=g(n)?{pageIndex:t,pageSize:n}:{pageIndex:1},s=x(v.data),a={};return a[v.sorting.sortColumn]=f(C.peek(),function(e){return e.key}),a[v.sorting.sortDirection]=f(C.peek(),function(e){return e.direction}),e.ajax({url:v.url.peek(),data:l(i,a,s),type:v.type||"get",dataType:v.dataType||"json"}).done(function(e){v.rows(e.rows),v.total(e.total||e.rows.length)}).always(function(){u(v.loaded)&&v.loaded(v.element,v.rows.peek())}).promise()},i(v.data)&&v.data.subscribe(v.refresh),v.url.subscribe(v.refresh),v.refresh();else{v.refresh=b;var I=k(v.rows);v.rows=a({read:function(){var e=v.pageSize(),t=(v.pageIndex()-1)*e;return I().slice(t,t+e)},write:function(e){I(e)}}),v.total(I.peek().length)}v.pageIndex.subscribe(v.refresh),v.pageSize.subscribe(function(){var e=v.totalPages.peek(),t=v.pageIndex.peek();t>e?v.pageIndex(e):v.refresh()}),v.height.subscribe(function(e){$(v.element,e)}),v.isColumnVisible=function(e){return e=e||this,i(e.visible)||_.isBoolean(e.visible)?e.visible:!0}},T={pageSize:25,pageSizeOptions:[10,25,50,100,200,"All"],pageIndex:1,pager:!0,height:"auto",loading:function(t){e("table",t).css({opacity:.5})},loaded:function(t){e("table",t).css({opacity:1})},noRows:"No rows available",sorting:{allowMultiSort:!1,sortColumn:"sortColumn",sortDirection:"sortDirection",asc:"asc",desc:"desc",noSortClass:"ko-grid-sort-none",ascendingClass:"ko-grid-sort-asc",descendingClass:"ko-grid-sort-desc",addjQueryUiSortingIcons:"auto"}},P={headContainer:{template:"<div data-bind='foreach : { data : columns, afterRender : $root.afterRender }'></div>",cssClass:"ko-grid-head-container"},head:{template:"<div data-bind='visible : $root.isColumnVisible($data), click : $root.sort, css : { \"ko-grid-is-sortable\" : $data.sortable } '><span data-bind='text : ($root.isString($data) ? $data : $data.title)'></span></div>",cssClass:"ko-grid-head"},sortIcon:{template:"<span type='button' data-bind='visible: $data.sortable,  css : $root.sortClass($data) '>Sort</span>",cssClass:"ko-grid-sort-icon"},scrollContainer:{template:"<div></div>",cssClass:"ko-grid-scroll-container"},table:{template:"<table cellspacing='0' cellpadding='0' data-bind='visible : any'><tbody data-bind='foreach : { data : rows, afterRender : $root.afterRender }'></tbody></table>",cssClass:"ko-grid-table"},row:{template:'<tr data-bind=\'foreach : $root.columns, click : $root.rowClick, css : $index()%2 ? $root.classes.row + "-even" : $root.classes.row + "-odd" \'></tr>',cssClass:"ko-grid-row"},cell:{template:"<td data-bind='kogrid$cell:$data'></td>",cssClass:"ko-grid-cell"},pager:{template:"<div></div>",cssClass:"ko-grid-pager"},first:{template:"<button type='button' data-bind='click : first, disable : pageIndex() == 1' title='First'>&lt;&lt; First</button>",cssClass:"ko-grid-first"},previous:{template:"<button type='button' data-bind='click : previous, disable : pageIndex() == 1' title='Previous'>&lt; Previous</button>",cssClass:"ko-grid-previous"},next:{template:"<button type='button' data-bind='click : next, disable : pageIndex() == totalPages()' title='Next'>Next &gt;</button>",cssClass:"ko-grid-next"},last:{template:"<button type='button' data-bind='click : last, disable : pageIndex() == totalPages()' title='Last'>Last  &gt;&gt;</button>",cssClass:"ko-grid-last"},refresh:{template:"<button type='button' data-bind='click : refresh' title='Refresh'>Refresh</button>",cssClass:"ko-grid-refresh"},pageSize:{template:"<select data-bind='options : pageSizeOptions, value : pageSize'></select>",cssClass:"ko-grid-page-size"},goToPage:{template:"<div><input type='text' data-bind='value : goToPageText'><button data-bind='click : goToPage'>Go</button></div>",cssClass:"ko-grid-go-to-page"},pagingText:{template:"<div>Page <span data-bind='text:pageIndex'></span> of <span data-bind='text: totalPages'></span></div>",cssClass:"ko-grid-paging-text"},totalText:{template:"<div><span data-bind='text:total'></span> records</div>",cssClass:"ko-grid-total-text"},noRows:{template:"<div data-bind='visible : none,html: noRows'></div>",cssClass:"ko-grid-no-rows"}};e(function(){e(d).on("resize",n(function(){var t={h:e(d).height(),w:e(d).width()},n=w.peek();(t.h!==n.h||t.w!==n.w)&&w(t)},100))});var z={kogrid$cell:{init:function(e,t,n,i,s){var a=s.$root,r=s.$parent,d=s.$data,c=a.templates[d.template],g={visible:a.isColumnVisible.bind(d)};if(c)g.template=v({name:c,data:l({},d.data,r)});else{var f,h=p(d)?d:d.key,b=r[h],f=u(b)?b():b;g.text=v(f)}return l(g,{style:v(d.style),css:v(d.css)}),o(e,g,s.extend({$columnIndex:v(s.$index()),$rowIndex:v(s.$parentContext.$index())})),{controlsDescendantBindings:!0}}},kogrid:{init:function(n,s){return e(function(){var a,o=function(){var e={};return c(P,function(t,n){e[n]=t.cssClass}),e}(),d=s(),u=new S(d,n,o),g=i(u.columns)?u.columns.peek():u.columns,f=e(n).addClass("ko-grid-main").css({height:u.height.peek()}),h=y(f,"headContainer",{position:"relative"}),v=y(h,"head"),k=(y(v,"sortIcon"),y(f,"scrollContainer")),x=y(k,"table",{position:"relative"}),w=y(x,"row");y(w,"cell"),y(k,"noRows"),u.pager&&(a=y(f,"pager"),u.refresh!==b&&y(a,"refresh"),y(a,"first"),y(a,"previous"),y(a,"pagingText"),y(a,"next"),y(a,"last"),y(a,"pageSize"),y(a,"goToPage"),y(a,"totalText"));var $=function(t){if(!r(t)){var i=C();u.templates[t]=i,e("<script type='text/html' id='"+i+"'>"+m(t)+"</script>").appendTo(n)}};_(g).filter(function(e){return p(e.template)}).each(function(e){$(e.template)}),I(u),t.applyBindingsToDescendants(u,n),d.utils=l({},d.utils,{fixHeaders:u.resizeHeaders,refresh:u.refresh,goToPage:function(e){self.pageIndex(e)}})}),{controlsDescendantBindings:!0}},options:T,templates:P}};l(t.bindingHandlers,z)};"undefined"!=typeof ko&&ko.observable&&e(jQuery,ko,_),"undefined"!=typeof define&&define.amd&&define(["jquery","knockout","_"],e)})();