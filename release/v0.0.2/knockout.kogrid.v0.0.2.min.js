/*
kogrid - created by Miguel Ludert
https://github.com/thinkingsites/kogrid

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
"use strict";(function(){var e=function(e,t,s){var n=function(e){return t.isObservable(e)?e:t.observable(e)},a=function(e){return t.isObservable(e)?e():e},i=function(e){return t.isObservable(e)?e.peek():e},o=t.observable({h:e(window).height(),w:e(window).width()}),r=function(){return"ko-grid-"+(""+Math.round(Math.random()*Math.pow(10,10)))},l=function(t,s,n){var a=g[s],i=e(a.template).appendTo(t);return a.cssClass&&i.addClass(a.cssClass),n&&i.css(n),i},d=function(t){if(t.addjQueryUiSortingIcons!==!1){var n=["ui-icon","ui-icon-triangle-2-n-s","ui-icon-triangle-1-n","ui-icon ui-icon-triangle-1-s"],a=t.addjQueryUiSortingIcons===!0,i=e.ui||s.any(document.styleSheets,function(e){return s(e.rules).map(function(e){return e.selectorText.slice(1)}).intersection(jquiStyles).value().length==n.length});(a||i)&&(t.sorting.noSortClass+=[void 0,n[0],n[1]].join(" "),t.sorting.ascendingClass+=[void 0,n[0],n[2]].join(" "),t.sorting.descendingClass+=[void 0,n[0],n[3]].join(" "))}},c=function(r,l,d){var c,g=this,b=t.observableArray();e.extend(g,p,r),g.element=l,g.templates={},g.classes=d,g.rows=n(g.rows),g.total=n(g.total),g.pageSize=n(g.pageSize),g.pageIndex=n(g.pageIndex),g.any=function(){var e=a(g.rows);return!(s.isUndefined(e)||0==e.length)},g.resizeHeaders=function(){var t,s,n=e("."+g.classes.head,g.element),a=e("."+g.classes.row+":first ."+g.classes.cell,g.element).map(function(){var t=e(this);return{left:t.position().left,width:t.width()}});if(n.length==a.length){n.first().parent().height(n.first().height());for(var i=0;n.length>i;i++)t=n.eq(i),s=a[i],t.css({position:"absolute",top:0,left:s.left-1,width:s.width,"float":"none",overflow:"hidden","white-space":"nowrap"})}},g.afterRender=s.debounce(function(){g.resizeHeaders(),s.isFunction(g.done)&&g.done(l)},100),g.isColumnVisible=function(e){return t.isObservable(e.visible)?e.visible():s.isBoolean(e.visible)?e.visible:!0},g.sort=function(){if(this.sortable===!0){var e=this,n=s.find(b.peek(),function(t){return t.key===e.key})||{key:e.key,direction:e.direction},a=s.filter(b.peek(),function(t){return t.key!=e.key});n.direction=n.direction===g.sorting.asc?g.sorting.desc:g.sorting.asc,g.sorting.allowMultiSort?(a.unshift(n),b(a)):b([n]),t.isObservable(e.direction)?e.direction(n.direction):e.direction=n.direction,s.isFunction(g.refresh)?g.refresh():t.isObservable(g.rows)}},g.sortClass=function(e){var t=s.find(b(),function(t){return t.key===e.key});if(t){if(t.direction==g.sorting.asc)return g.sorting.ascendingClass;if(t.direction==g.sorting.desc)return g.sorting.descendingClass}return g.sorting.noSortClass},g.selectCellTemplate=function(e,t){var n,a=g.templates[e.template];if(a)n={name:a,data:s.extend({},e.data,t)};else var i,o=s.isString(e)?e:e.key,r=t[o],i=s.isFunction(r)?r():r,n={name:u,data:i};return n},t.isObservable(g.total)||(g.total=t.computed({read:function(){return s.isNumber(c)?c:t.isObservable(g.rows)?g.rows.peek().length:s.isArray(g.rows)?g.rows.length:void 0},write:function(e){c=e}})),g.totalPages=t.computed(function(){var e=g.total(),t=g.pageSize();return s.isNumber(e)&&s.isNumber(t)?Math.ceil(e/t):1}),g.first=function(){g.pageIndex(1)},g.previous=function(){var e=g.pageIndex.peek();g.pageIndex(Math.max(1,e-1))},g.next=function(){var e=g.pageIndex.peek(),t=g.totalPages.peek();g.pageIndex(Math.min(t,e+1))},g.last=function(){g.pageIndex(g.totalPages.peek())},g.goToPage=function(){var e=parseInt(g.goToPageText.peek());s.isNumber(e)&&e>=1&&g.totalPages.peek()>=e?g.pageIndex(e):g.goToPageText("")},g.goToPageText=t.observable(),o.subscribe(g.resizeHeaders),function f(e){s.forOwn(e,function(e){var n=e;t.isObservable(n)&&(n.subscribe(function(){g.afterRender()}),n=n()),s.isObject(n)&&f(n)})}(r),s.isString(g.url)&&(g.refresh=function(){s.isFunction(g.loading)&&g.loading(g.element,g.rows.peek());var t=g.pageIndex.peek(),n=g.pageSize.peek(),a=s.isNumber(n)?{pageIndex:t,pageSize:n}:{pageIndex:1},o=i(g.data),r={};return r[g.sorting.sortColumn]=s.map(b.peek(),function(e){return e.key}),r[g.sorting.sortDirection]=s.map(b.peek(),function(e){return e.direction}),e.ajax({url:g.url,data:s.extend(a,r,o),type:g.type||"get",dataType:g.dataType||"json"}).done(function(e){g.rows(e.rows),g.total(e.total||e.rows.length)}).always(function(){s.isFunction(g.loaded)&&g.loaded(g.element,g.rows.peek())}).promise()},t.isObservable(g.data)&&g.data.subscribe(g.refresh),g.pageIndex.subscribe(g.refresh),g.pageSize.subscribe(g.refresh),g.refresh())},u="ko-grid-default-cell-template",p={pageSize:25,pageSizeOptions:[10,25,50,100,200,"All"],pageIndex:1,pager:!0,height:"auto",loading:function(t){e("table",t).css({opacity:.5})},loaded:function(t){e("table",t).css({opacity:1})},noRowsText:"No rows available",sorting:{allowMultiSort:!1,sortColumn:"sortColumn",sortDirection:"sortDirection",asc:"asc",desc:"desc",noSortClass:"ko-grid-sort-none",ascendingClass:"ko-grid-sort-asc",descendingClass:"ko-grid-sort-desc",addjQueryUiSortingIcons:"auto"}},g={headContainer:{template:"<div data-bind='foreach : { data : columns, afterRender : $root.afterRender }'></div>",cssClass:"ko-grid-head-container"},head:{template:"<div data-bind='visible : $root.isColumnVisible($data), click : $root.sort, css : { \"ko-grid-is-sortable\" : $data.sortable } '><span data-bind='text : (_.isString($data) ? $data : $data.title)'></span></div>",cssClass:"ko-grid-head"},sortIcon:{template:"<span type='button' data-bind='visible: $data.sortable,  css : $root.sortClass($data) '>Sort</span>",cssClass:"ko-grid-sort-icon"},scrollContainer:{template:"<div></div>",cssClass:"ko-grid-scroll-container"},table:{template:"<table cellspacing='0' cellpadding='0' data-bind='visible : any'><tbody data-bind='foreach : { data : rows, afterRender : $root.afterRender }'></tbody></table>",cssClass:"ko-grid-table"},row:{template:'<tr data-bind=\'foreach : $root.columns, css : $index()%2 ? $root.classes.row + "-even" : $root.classes.row + "-odd" \'></tr>',cssClass:"ko-grid-row"},cell:{template:"<td data-bind='template : $root.selectCellTemplate($data,$parent), visible : $root.isColumnVisible($data), style : $data.style, css : $data.css'></td>",cssClass:"ko-grid-cell"},pager:{template:"<div></div>",cssClass:"ko-grid-pager"},first:{template:"<button type='button' data-bind='click : first, disable : pageIndex() == 1' title='First'>&lt;&lt; First</button>",cssClass:"ko-grid-first"},previous:{template:"<button type='button' data-bind='click : previous, disable : pageIndex() == 1' title='Previous'>&lt; Previous</button>",cssClass:"ko-grid-previous"},next:{template:"<button type='button' data-bind='click : next, disable : pageIndex() == totalPages()' title='Next'>Next &gt;</button>",cssClass:"ko-grid-next"},last:{template:"<button type='button' data-bind='click : last, disable : pageIndex() == totalPages()' title='Last'>Last  &gt;&gt;</button>",cssClass:"ko-grid-last"},refresh:{template:"<button type='button' data-bind='click : refresh' title='Refresh'>Refresh</button>",cssClass:"ko-grid-refresh"},pageSize:{template:"<select data-bind='options : pageSizeOptions, value : pageSize'></select>",cssClass:"ko-grid-page-size"},goToPage:{template:"<div><input type='text' data-bind='value : goToPageText'><button data-bind='click : goToPage'>Go</button></div>",cssClass:"ko-grid-go-to-page"},pagingText:{template:"<div>Page <span data-bind='text:pageIndex'></span> of <span data-bind='text: totalPages'></span></div>",cssClass:"ko-grid-paging-text"},totalText:{template:"<div><span data-bind='text:total'></span> records</div>",cssClass:"ko-grid-total-text"},noRows:{template:"<div data-bind='visible : !any(), text : $root.noRowsText'></div>",cssClass:"ko-grid-no-rows"},cellContentTemplate:{template:"<script type='text/html' id='"+u+"'><!-- ko text: $data --><!-- /ko --></script>"}};e(window).on("resize",s.debounce(function(){var t={h:e(window).height(),w:e(window).width()},s=o.peek();(t.h!==s.h||t.w!==s.w)&&o(t)},100)),t.bindingHandlers.kogrid={init:function(n,a){return e(function(){var i,o=function(){var e={};return s.each(g,function(t,s){e[s]=t.cssClass}),e}(),u=a(),p=new c(u,n,o),b=t.isObservable(p.columns)?p.columns.peek():p.columns,f=e(n).addClass(o.main),v=l(f,"headContainer",{position:"relative"}),m=l(v,"head"),h=(l(m,"sortIcon"),l(f,"scrollContainer")),k=l(h,"noRows"),k=l(h,"table",{position:"relative"}),x=l(k,"row");l(x,"cell"),l(f,"cellContentTemplate"),p.pager&&(i=l(f,"pager"),(s.isFunction(p.refresh)||p.url)&&l(i,"refresh"),l(i,"first"),l(i,"previous"),l(i,"pagingText"),l(i,"next"),l(i,"last"),l(i,"pageSize"),l(i,"goToPage"),l(i,"totalText")),s(b).filter(function(e){return s.isString(e.template)}).each(function(t){if(!s.isElement(document.getElementById(t.template))){var a=r();p.templates[t.template]=a,e("<script type='text/html' id='"+a+"'>"+t.template+"</script>").appendTo(n)}}),d(p),t.applyBindingsToDescendants(p,n),u.utils=s.extend({},u.utils,{fixHeaders:p.resizeHeaders,refresh:p.refresh,goToPage:function(e){self.pageIndex(e)}})}),{controlsDescendantBindings:!0}},options:p,templates:g}};"undefined"!=typeof ko&&ko.observable&&e(jQuery,ko,_),"undefined"!=typeof define&&define.amd&&define(["jquery","knockout","_"],e)})();