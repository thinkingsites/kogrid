/*
kogrid 0.1.6 - created by Miguel Ludert
https://github.com/thinkingsites/kogrid

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

!function(a){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?a(require("knockout"),require("jquery"),require("lodash"),exports):"function"==typeof define&&define.amd?define(["knockout","jquery","lodash","exports"],a):a(ko,$,_,{})}(function(a,b,c){if(void 0===typeof a)throw"Knockout is required, please ensure it is loaded before loading this validation plug-in";if(void 0===typeof b)throw"jQuery is required, please ensure it is loaded before loading this validation plug-in";if(void 0===typeof c)throw"LoDash is required, please ensure it is loaded before loading this validation plug-in";var d=c.debounce,e=a.isObservable,f=a.observable,g=a.observableArray,h=a.computed,i=c.extend,j=window,k=c.each,l=c.isFunction,m=c.isNumber,n=c.isString,o=c.map,p=c.find,q=a.utils.unwrapObservable,r=a.bindingHandlers,s=a.applyBindingAccessorsToNode||function(b,d,e){var f={};return c.each(d,function(a,b){f[b]=a()}),a.applyBindingsToNode(b,f,e)},t=function(a){return c.isString(a)&&document.getElementById(a)||c.isElement(a)},u=function(){},v=function(a){return function(){return this}.bind(a)},w=function(a){return e(a)?a:f(a)},x=function(a){return e(a)?a.peek():a},y=f({h:j.screen.height,w:j.screen.width}),z=function(){return"ko-grid-"+Math.round(Math.random()*Math.pow(10,10)).toString()},A=function(a,c,d){var e=H[c],f=b(e.template).appendTo(a);return e.cssClass&&f.addClass(e.cssClass),d&&f.css(d),f},B=function(a){if(a.addjQueryUiSortingIcons!==!1){var b=["ui-icon","ui-icon-triangle-2-n-s","ui-icon-triangle-1-n","ui-icon ui-icon-triangle-1-s"],d=a.addjQueryUiSortingIcons===!0,e=j.jQuery&&j.jQuery.ui||c.any(document.styleSheets,function(a){return c(a.rules).filter(function(a){return a.selectorText}).map(function(a){return a.selectorText.slice(1)}).intersection(b).value().length==b.length});(d||e)&&(a.sorting.noSortClass+=[void 0,b[0],b[1]].join(" "),a.sorting.ascendingClass+=[void 0,b[0],b[2]].join(" "),a.sorting.descendingClass+=[void 0,b[0],b[3]].join(" "))}},C=function(a,c){var d=b(a),c=parseInt(c)||c,e=b("."+H.scrollContainer.cssClass,d),f=b("."+H.headContainer.cssClass,d).outerHeight(),g=b("."+H.pager.cssClass,d).outerHeight();d.css("height",c),"auto"!==c&&"inherit"!==c?e.css("height",d.innerHeight()-f-g):e.css("height",c)},D=function(a,b){return(a.pageIndex.peek()-1)*a.pageSize.peek()+b},E=function(a,b,c){return{$columnValue:v(b),$rowIndex:v(c),$recordIndex:v(D(a,c))}},F=function(j,k,r){if(!j.url&&!j.rows)throw"kogrid: Either 'url' or 'rows' must be defined in the grid options";var s,t=this,v=g(),z=g();if(b.extend(!0,t,G,j),t.templates={},t.element=k,t.classes=r,t.rows=w(t.rows||[]),t.height=w(t.height),t.total=w(t.total||0),t.pageSize=w(t.pageSize),t.pageIndex=w(t.pageIndex),t.url=w(t.url),t.rowClick=function(a,b){var c=this;return c?c.call(a,a,b):!0}.bind(t.rowClick),t.isString=n,t.any=h(function(){var a=q(t.rows);return!(c.isUndefined(a)||0==a.length)}),t.none=h(function(){var a=q(t.rows);return c.isUndefined(a)||0==a.length}),t.noneText=f(t.messages.initial),t.resizeHeaders=function(){var a,c,d=b("."+t.classes.head,t.element),e=b("."+t.classes.row+":first ."+t.classes.cell,t.element).map(function(){var a=b(this);return{left:a.position().left,width:a.width()}});if(d.length!=e.length)return void d.css({position:"relative",top:0,left:"auto",width:Math.floor(100/d.length)+"%"}).width();d.first().parent().height(d.first().height());for(var f=0;f<d.length;f++)a=d.eq(f),c=e[f],a.css({position:"absolute",top:0,left:c.left-1,width:c.width})},t.afterRender=d(function(){t.resizeHeaders(),C(t.element,t.height.peek()),l(t.done)&&t.done(k,t.utils)},10),t.sort=function(){if(this.sortable===!0){var a=this,b=p(v.peek(),function(b){return b.key===a.key})||{key:a.key,direction:a.direction},d=c.filter(v.peek(),function(b){return b.key!=a.key});b.direction=b.direction===t.sorting.asc?t.sorting.desc:t.sorting.asc,t.sorting.allowMultiSort?(d.unshift(b),v(d)):v([b]),e(a.direction)?a.direction(b.direction):a.direction=b.direction,l(t.refresh)?t.refresh():e(t.rows)}},t.sortClass=function(a){var b=p(v(),function(b){return b.key===a.key});if(b){if(b.direction==t.sorting.asc)return t.sorting.ascendingClass;if(b.direction==t.sorting.desc)return t.sorting.descendingClass}return t.sorting.noSortClass},e(t.total)||(t.total=h({read:function(){return m(s)?s:e(t.rows)?t.rows.peek().length:c.isArray(t.rows)?t.rows.length:void 0},write:function(a){s=a}})),t.totalPages=h(function(){var a=t.total(),b=t.pageSize();return m(a)&&m(b)&&a?Math.ceil(a/b):0}),t.first=function(){t.pageIndex(1)},t.previous=function(){var a=t.pageIndex.peek();t.pageIndex(Math.max(1,a-1))},t.next=function(){var a=t.pageIndex.peek(),b=t.totalPages.peek();t.pageIndex(Math.min(b,a+1))},t.last=function(){t.pageIndex(t.totalPages.peek())},t.goToPage=function(){var a=parseInt(t.goToPageText.peek());m(a)&&a>=1&&a<=t.totalPages.peek()?t.pageIndex(a):t.goToPageText("")},t.goToPageText=f(),y.subscribe(t.resizeHeaders),function B(a){c.forOwn(a,function(a){var b=a;e(b)&&(b.subscribe(function(){t.afterRender()}),b=b()),c.isObject(b)&&B(b)})}(j),n(t.url.peek()))t.rows=w(t.rows),t.refresh=function(){l(t.loading)&&t.loading(t.element,t.rows.peek()),t.noneText(t.messages.loading);var d=t.pageIndex.peek(),e=t.pageSize.peek(),f=m(e)?{pageIndex:d,pageSize:e}:{pageIndex:1},g=x(t.data),h={};return h[t.sorting.sortColumn]=o(v.peek(),function(a){return a.key}),h[t.sorting.sortDirection]=o(v.peek(),function(a){return a.direction}),g=a.toJS(g),t.cleanPostData!==!1&&c.each(g,function(a,b){(c.isUndefined(a)||c.isNull(a))&&(g[b]="")}),b.ajax({url:t.url.peek(),data:i(f,h,t.sanitize(g)),type:t.type||"get",dataType:t.dataType||"json",async:t.async}).done(function(a,b,c){var d=t.getRows(a,c),e=t.getTotal(a,c);t.rows(l(t.map)?o(d,t.map):d),t.total(e||d.length||0),t.noneText(t.noRows||t.messages.noRows)}).always(function(){l(t.loaded)&&t.loaded(t.element,t.rows.peek())}).promise()},e(t.data)&&t.data.subscribe(t.refresh),t.url.subscribe(t.refresh),t.autoLoad&&t.refresh();else{t.refresh=u;var A=w(l(t.map)?o(q(t.rows),t.map):t.rows);t.rows=h({read:function(){var a=t.pageSize(),b=(t.pageIndex()-1)*a;return A().slice(b,b+a)},write:function(a){A(l(t.map)?o(q(a),t.map):a)}}),t.total(A.peek().length)}t.clear=function(){t.rows([]),t.total(0),t.noneText(t.messages.initial)},t.pageIndex.subscribe(t.refresh),t.pageSize.subscribe(function(){var a=t.totalPages.peek(),b=t.pageIndex.peek();b>a?t.pageIndex(a):t.refresh()}),t.height.subscribe(function(a){C(t.element,a)}),t.isColumnVisible=function(a){return a=a||this,e(a.visible)||c.isBoolean(a.visible)?a.visible:!0},t.cb={visible:function(){return!c.isEmpty(t.checkbox)},value:function(a){var b=a.$index(),a=i({},a,E(t,-1,b));return t.id?a.$data[t.id]:a.$recordIndex},change:function(a,d){var e=!0,f=t.checkbox.change,g=this.$index(),h=i({},this,E(t,-1,g));if(b(d.target).is(":checked")?z.push({i:h.$recordIndex(),v:h.$data}):z.remove(function(a){return a.i==h.$recordIndex()}),!t.checkbox.multiple){var j=c.filter(z.peek(),function(a){return a.i==h.$recordIndex()});z(j)}return l(f)&&(e=f.call(h.$data,h.$data,d,h)),e===!1?!1:!0},checked:function(a){var b;return b=t.id?function(b){return b.v[t.id]==a.$data[t.id]}:function(b){return b.i==D(t,a.$index())},c.find(z(),b)},rows:z},this.utils={fixHeaders:t.resizeHeaders,refresh:t.refresh,clear:t.clear,goToPage:function(a){t.pageIndex(a)},getChecked:function(a){var b=c.sortBy(t.cb.rows(),"i");return o(b,function(b){return a?b.i:b.v})},checkedAll:function(){t.cb.rows(c.times(t.total()))},uncheckAll:function(){return t.cb.rows.removeAll()},element:function(){return k}},e(t.checkedRows)&&z.subscribe(function(){var a=c.sortBy(z(),"i"),b=o(a,function(a){return a.v});t.checkedRows(b)})},G={pageSize:25,pageSizeOptions:[10,25,50,100,200,"All"],pageIndex:1,pager:!0,height:"auto",autoLoad:!0,async:!0,loading:function(a){b("table",a).css({opacity:.5})},loaded:function(a){b("table",a).css({opacity:1})},messages:{initial:"",noRows:"No rows available",loading:"Loading..."},checkbox:!1,sorting:{allowMultiSort:!1,sortColumn:"sortColumn",sortDirection:"sortDirection",asc:"asc",desc:"desc",noSortClass:"ko-grid-sort-none",ascendingClass:"ko-grid-sort-asc",descendingClass:"ko-grid-sort-desc",addjQueryUiSortingIcons:"auto"},getRows:function(a){return a.rows},getTotal:function(a){return a.total},sanitize:function(a){return a}},H={headContainer:{template:"<div></div>",cssClass:"ko-grid-head-container"},head:{template:"<!-- ko foreach : { data : columns, afterRender : $root.afterRender } --><div data-bind='visible : $root.isColumnVisible($data), click : $root.sort, css : { \"ko-grid-is-sortable\" : $data.sortable } '><span data-bind='text : ($root.isString($data) ? $data : $data.title)'></span></div><!-- /ko -->",cssClass:"ko-grid-head"},sortIcon:{template:"<span type='button' data-bind='visible: $data.sortable,  css : $root.sortClass($data) '>Sort</span>",cssClass:"ko-grid-sort-icon"},scrollContainer:{template:"<div></div>",cssClass:"ko-grid-scroll-container"},table:{template:"<table cellspacing='0' cellpadding='0' data-bind='visible : any'><tbody data-bind='foreach : { data : rows, afterRender : $root.afterRender }'></tbody></table>",cssClass:"ko-grid-table"},row:{template:'<tr data-bind=\'click : $root.rowClick, css : $index()%2 ? $root.classes.row + "-even" : $root.classes.row + "-odd" \'></tr>',cssClass:"ko-grid-row"},cell:{template:"<!-- ko foreach : $root.columns --><td data-bind='kogrid$cell:$data'></td><!-- /ko -->",cssClass:"ko-grid-cell"},pager:{template:"<div></div>",cssClass:"ko-grid-pager"},first:{template:"<button type='button' data-bind='click : first, disable : pageIndex() == 1' title='First'>&lt;&lt; First</button>",cssClass:"ko-grid-first"},previous:{template:"<button type='button' data-bind='click : previous, disable : pageIndex() == 1' title='Previous'>&lt; Previous</button>",cssClass:"ko-grid-previous"},next:{template:"<button type='button' data-bind='click : next, disable : pageIndex() == totalPages()' title='Next'>Next &gt;</button>",cssClass:"ko-grid-next"},last:{template:"<button type='button' data-bind='click : last, disable : pageIndex() == totalPages()' title='Last'>Last  &gt;&gt;</button>",cssClass:"ko-grid-last"},refresh:{template:"<button type='button' data-bind='click : refresh' title='Refresh'>Refresh</button>",cssClass:"ko-grid-refresh"},pageSize:{template:"<select data-bind='options : pageSizeOptions, value : pageSize'></select>",cssClass:"ko-grid-page-size"},goToPage:{template:"<div><input type='text' data-bind='value : goToPageText'><button data-bind='click : goToPage'>Go</button></div>",cssClass:"ko-grid-go-to-page"},pagingText:{template:"<div>Page <span data-bind='text:pageIndex'></span> of <span data-bind='text: totalPages'></span></div>",cssClass:"ko-grid-paging-text"},totalText:{template:"<div><span data-bind='text:total'></span> records</div>",cssClass:"ko-grid-total-text"},noRows:{template:"<div data-bind='visible : none,html: noneText'></div>",cssClass:"ko-grid-no-rows"},checkbox:{template:"<td style='text-align:center' data-bind='visible : $root.cb.visible'><input type='checkbox' data-bind='checked : $root.cb.checked($context), value: $root.cb.value($context), event : { click : $root.cb.change.bind($context) }'/></td>",cssClass:"ko-grid-checkbox"}};r.kogrid$cell={init:function(a,b,c,d,e){var f=e.$root,g=e.$parent,h=e.$data,j=f.templates[h.template],k={visible:f.isColumnVisible.bind(h)};if(j)k.template=v({name:j,data:i({},h.data,g)});else{var m,o=n(h)?h:h.key,p=g[o],m=l(p)?p():p;k.text=v(m)}i(k,{style:v(h.style),css:v(h.css)});var q=E(e.$root,e.$parentContext.$index(),e.$index());return s(a,k,e.extend(q)),{controlsDescendantBindings:!0}}},r.kogrid={init:function(d,f){return b(function(){{var g,h=function(){var a={};return k(H,function(b,c){a[c]=b.cssClass}),a}(),j=f(),l=new F(j,d,h),m=e(l.columns)?l.columns.peek():l.columns,o=b(d).addClass("ko-grid-main").css({height:l.height.peek()}),p=A(o,"headContainer",{position:"relative"}),r=(c.isEmpty(l.checkbox)?void 0:b("<div></div>").addClass(H.head.cssClass).appendTo(p),A(p,"head")),s=(A(r,"sortIcon"),A(o,"scrollContainer")),v=A(s,"table",{position:"relative"}),w=A(v,"row");c.isEmpty(l.checkbox)?void 0:A(w,"checkbox").addClass(H.cell.cssClass),A(w,"cell"),A(s,"noRows")}l.pager&&(g=A(o,"pager"),l.refresh!==u&&A(g,"refresh"),A(g,"first"),A(g,"previous"),A(g,"pagingText"),A(g,"next"),A(g,"last"),A(g,"pageSize"),A(g,"goToPage"),A(g,"totalText"));var x=function(a){if(t(a))c.isString(a)&&(l.templates[a]=a);else{var e=z();l.templates[a]=e,b("<script type='text/html' id='"+e+"'>"+q(a)+"</script>").appendTo(d)}};c(m).filter(function(a){return n(a.template)}).each(function(a){x(a.template)}),B(l),a.applyBindingsToDescendants(l,d),j.utils=i(j.utils||{},l.utils),jQuery&&jQuery.ui&&jQuery.ui.tabs&&b(d).parents(".ui-tabs.ui-widget").on("tabsactivate",function(){l.utils.fixHeaders()})}),{controlsDescendantBindings:!0}},options:G,templates:H},b(function(){b(j).on("resize",d(function(){var a={h:b(j).height(),w:b(j).width()},c=y.peek();(a.h!==c.h||a.w!==c.w)&&y(a)},100))})});