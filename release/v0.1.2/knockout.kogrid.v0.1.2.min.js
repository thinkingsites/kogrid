/*
kogrid - created by Miguel Ludert
https://github.com/thinkingsites/kogrid

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
"use strict";(function(){var e=function(e,t){var n=_.debounce,s=t.isObservable,i=(t.bindingHanders,t.applyBindingAccessorsToNode||function(e,n,s){var i={};return _.each(n,function(e,t){i[t]=e()}),t.applyBindingsToNode(e,i,s)}),a=function(e){return _.isString(e)&&document.getElementById(e)||_.isElement(e)},o=_.extend,r=t.observable,d=window,l=_.each,c=_.isFunction,u=_.isNumber,g=_.isString,p=_.map,f=_.find,h=function(){},b=function(e){return function(){return this}.bind(e)},v=function(e){return s(e)?e:r(e)},k=function(e){return s(e)?e():e},m=function(e){return s(e)?e.peek():e},x=r({h:e(d).height(),w:e(d).width()}),w=function(){return"ko-grid-"+(""+Math.round(Math.random()*Math.pow(10,10)))},C=function(t,n,s){var i=T[n],a=e(i.template).appendTo(t);return i.cssClass&&a.addClass(i.cssClass),s&&a.css(s),a},y=function(t){if(t.addjQueryUiSortingIcons!==!1){var n=["ui-icon","ui-icon-triangle-2-n-s","ui-icon-triangle-1-n","ui-icon ui-icon-triangle-1-s"],s=t.addjQueryUiSortingIcons===!0,i=e.ui||_.any(document.styleSheets,function(e){return _(e.rules).filter(function(e){return e.selectorText}).map(function(e){return e.selectorText.slice(1)}).intersection(n).value().length==n.length});(s||i)&&(t.sorting.noSortClass+=[void 0,n[0],n[1]].join(" "),t.sorting.ascendingClass+=[void 0,n[0],n[2]].join(" "),t.sorting.descendingClass+=[void 0,n[0],n[3]].join(" "))}},I=function(t,n){var s=e(t),n=parseInt(n)||n,i=e("."+T.scrollContainer.cssClass,s),a=e("."+T.headContainer.cssClass,s).outerHeight(),o=e("."+T.pager.cssClass,s).outerHeight();s.css("height",n),"auto"!==n&&"inherit"!==n?i.css("height",s.innerHeight()-a-o):i.css("height",n)},$=function(i,a,d){var l,b=this,w=t.observableArray();if(o(b,S,i),b.templates={},b.element=a,b.classes=d,b.rows=v(b.rows),b.height=v(b.height),b.total=v(b.total),b.pageSize=v(b.pageSize),b.pageIndex=v(b.pageIndex),b.url=v(b.url),b.isString=g,b.any=function(){var e=k(b.rows);return!(_.isUndefined(e)||0==e.length)},b.none=function(){var e=k(b.rows);return _.isUndefined(e)||0==e.length},b.resizeHeaders=function(){var t,n,s=e("."+b.classes.head,b.element),i=e("."+b.classes.row+":first ."+b.classes.cell,b.element).map(function(){var t=e(this);return{left:t.position().left,width:t.width()}});if(s.length!=i.length)return s.css({position:"relative",top:0,left:"auto",width:Math.floor(100/s.length)+"%"}).width(),void 0;s.first().parent().height(s.first().height());for(var a=0;s.length>a;a++)t=s.eq(a),n=i[a],t.css({position:"absolute",top:0,left:n.left-1,width:n.width})},b.afterRender=n(function(){b.resizeHeaders(),I(b.element,b.height.peek()),c(b.done)&&b.done(a)},10),b.sort=function(){if(this.sortable===!0){var e=this,t=f(w.peek(),function(t){return t.key===e.key})||{key:e.key,direction:e.direction},n=_.filter(w.peek(),function(t){return t.key!=e.key});t.direction=t.direction===b.sorting.asc?b.sorting.desc:b.sorting.asc,b.sorting.allowMultiSort?(n.unshift(t),w(n)):w([t]),s(e.direction)?e.direction(t.direction):e.direction=t.direction,c(b.refresh)?b.refresh():s(b.rows)}},b.sortClass=function(e){var t=f(w(),function(t){return t.key===e.key});if(t){if(t.direction==b.sorting.asc)return b.sorting.ascendingClass;if(t.direction==b.sorting.desc)return b.sorting.descendingClass}return b.sorting.noSortClass},s(b.total)||(b.total=t.computed({read:function(){return u(l)?l:s(b.rows)?b.rows.peek().length:_.isArray(b.rows)?b.rows.length:void 0},write:function(e){l=e}})),b.totalPages=t.computed(function(){var e=b.total(),t=b.pageSize();return u(e)&&u(t)?Math.ceil(e/t):1}),b.first=function(){b.pageIndex(1)},b.previous=function(){var e=b.pageIndex.peek();b.pageIndex(Math.max(1,e-1))},b.next=function(){var e=b.pageIndex.peek(),t=b.totalPages.peek();b.pageIndex(Math.min(t,e+1))},b.last=function(){b.pageIndex(b.totalPages.peek())},b.goToPage=function(){var e=parseInt(b.goToPageText.peek());u(e)&&e>=1&&b.totalPages.peek()>=e?b.pageIndex(e):b.goToPageText("")},b.goToPageText=r(),x.subscribe(b.resizeHeaders),function C(e){_.forOwn(e,function(e){var t=e;s(t)&&(t.subscribe(function(){b.afterRender()}),t=t()),_.isObject(t)&&C(t)})}(i),g(b.url.peek()))b.rows=v(b.rows),b.refresh=function(){c(b.loading)&&b.loading(b.element,b.rows.peek());var t=b.pageIndex.peek(),n=b.pageSize.peek(),s=u(n)?{pageIndex:t,pageSize:n}:{pageIndex:1},i=m(b.data),a={};return a[b.sorting.sortColumn]=p(w.peek(),function(e){return e.key}),a[b.sorting.sortDirection]=p(w.peek(),function(e){return e.direction}),e.ajax({url:b.url.peek(),data:o(s,a,i),type:b.type||"get",dataType:b.dataType||"json"}).done(function(e){b.rows(e.rows),b.total(e.total||e.rows.length)}).always(function(){c(b.loaded)&&b.loaded(b.element,b.rows.peek())}).promise()},s(b.data)&&b.data.subscribe(b.refresh),b.url.subscribe(b.refresh),b.refresh();else{b.refresh=h;var y=v(b.rows);b.rows=t.computed({read:function(){var e=b.pageSize(),t=(b.pageIndex()-1)*e;return y().slice(t,t+e)},write:function(e){y(e)}}),b.total(y.peek().length)}b.pageIndex.subscribe(b.refresh),b.pageSize.subscribe(function(){var e=b.totalPages.peek(),t=b.pageIndex.peek();t>e?b.pageIndex(e):b.refresh()}),b.height.subscribe(function(e){I(b.element,e)}),b.isColumnVisible=function(e){return e=e||this,s(e.visible)||_.isBoolean(e.visible)?e.visible:!0}},S={pageSize:25,pageSizeOptions:[10,25,50,100,200,"All"],pageIndex:1,pager:!0,height:"auto",loading:function(t){e("table",t).css({opacity:.5})},loaded:function(t){e("table",t).css({opacity:1})},noRows:"No rows available",sorting:{allowMultiSort:!1,sortColumn:"sortColumn",sortDirection:"sortDirection",asc:"asc",desc:"desc",noSortClass:"ko-grid-sort-none",ascendingClass:"ko-grid-sort-asc",descendingClass:"ko-grid-sort-desc",addjQueryUiSortingIcons:"auto"}},T={headContainer:{template:"<div data-bind='foreach : { data : columns, afterRender : $root.afterRender }'></div>",cssClass:"ko-grid-head-container"},head:{template:"<div data-bind='visible : $root.isColumnVisible($data), click : $root.sort, css : { \"ko-grid-is-sortable\" : $data.sortable } '><span data-bind='text : ($root.isString($data) ? $data : $data.title)'></span></div>",cssClass:"ko-grid-head"},sortIcon:{template:"<span type='button' data-bind='visible: $data.sortable,  css : $root.sortClass($data) '>Sort</span>",cssClass:"ko-grid-sort-icon"},scrollContainer:{template:"<div></div>",cssClass:"ko-grid-scroll-container"},table:{template:"<table cellspacing='0' cellpadding='0' data-bind='visible : any'><tbody data-bind='foreach : { data : rows, afterRender : $root.afterRender }'></tbody></table>",cssClass:"ko-grid-table"},row:{template:'<tr data-bind=\'foreach : $root.columns, css : $index()%2 ? $root.classes.row + "-even" : $root.classes.row + "-odd" \'></tr>',cssClass:"ko-grid-row"},cell:{template:"<td data-bind='kogrid$cell:$data'></td>",cssClass:"ko-grid-cell"},pager:{template:"<div></div>",cssClass:"ko-grid-pager"},first:{template:"<button type='button' data-bind='click : first, disable : pageIndex() == 1' title='First'>&lt;&lt; First</button>",cssClass:"ko-grid-first"},previous:{template:"<button type='button' data-bind='click : previous, disable : pageIndex() == 1' title='Previous'>&lt; Previous</button>",cssClass:"ko-grid-previous"},next:{template:"<button type='button' data-bind='click : next, disable : pageIndex() == totalPages()' title='Next'>Next &gt;</button>",cssClass:"ko-grid-next"},last:{template:"<button type='button' data-bind='click : last, disable : pageIndex() == totalPages()' title='Last'>Last  &gt;&gt;</button>",cssClass:"ko-grid-last"},refresh:{template:"<button type='button' data-bind='click : refresh' title='Refresh'>Refresh</button>",cssClass:"ko-grid-refresh"},pageSize:{template:"<select data-bind='options : pageSizeOptions, value : pageSize'></select>",cssClass:"ko-grid-page-size"},goToPage:{template:"<div><input type='text' data-bind='value : goToPageText'><button data-bind='click : goToPage'>Go</button></div>",cssClass:"ko-grid-go-to-page"},pagingText:{template:"<div>Page <span data-bind='text:pageIndex'></span> of <span data-bind='text: totalPages'></span></div>",cssClass:"ko-grid-paging-text"},totalText:{template:"<div><span data-bind='text:total'></span> records</div>",cssClass:"ko-grid-total-text"},noRows:{template:"<div></div>",cssClass:"ko-grid-no-rows"}};e(function(){e(d).on("resize",n(function(){var t={h:e(d).height(),w:e(d).width()},n=x.peek();(t.h!==n.h||t.w!==n.w)&&x(t)},100))});var P={kogrid$cell:{init:function(e,t,n,s,a){var r=a.$root,d=a.$parent,l=a.$data,u=r.templates[l.template],p={visible:r.isColumnVisible.bind(l)};if(u)p.template=b({name:u,data:o({},l.data,d)});else{var f,h=g(l)?l:l.key,v=d[h],f=c(v)?v():v;p.text=b(f)}return o(p,{style:b(l.style),css:b(l.css)}),i(e,p,a.extend({$columnIndex:b(a.$index()),$rowIndex:b(a.$parentContext.$index())})),{controlsDescendantBindings:!0}}},kogrid:{init:function(n,r){return e(function(){var d,c=function(){var e={};return l(T,function(t,n){e[n]=t.cssClass}),e}(),u=r(),p=new $(u,n,c),f=s(p.columns)?p.columns.peek():p.columns,v=e(n).addClass("ko-grid-main").css({height:p.height.peek()}),m=C(v,"headContainer",{position:"relative"}),x=C(m,"head"),I=(C(x,"sortIcon"),C(v,"scrollContainer")),S=C(I,"table",{position:"relative"}),P=C(S,"row");C(P,"cell"),p.pager&&(d=C(v,"pager"),p.refresh!==h&&C(d,"refresh"),C(d,"first"),C(d,"previous"),C(d,"pagingText"),C(d,"next"),C(d,"last"),C(d,"pageSize"),C(d,"goToPage"),C(d,"totalText"));var z=function(t){if(!a(t)){var s=w();p.templates[t]=s,e("<script type='text/html' id='"+s+"'>"+k(t)+"</script>").appendTo(n)}};_(f).filter(function(e){return g(e.template)}).each(function(e){z(e.template)}),y(p),t.applyBindingsToDescendants(p,n);var R=C(I,"noRows"),j={visible:b(p.none),template:b({name:function(){var e=k(p.noRows);return a(e)?e:p.templates[e]},data:u})};z(k(p.noRows)),s(p.noRows)&&p.noRows.subscribe(function(e){p.templates[e]||z(e)}),i(R[0],j),u.utils=o({},u.utils,{fixHeaders:p.resizeHeaders,refresh:p.refresh,goToPage:function(e){self.pageIndex(e)}})}),{controlsDescendantBindings:!0}},options:S,templates:T}};o(t.bindingHandlers,P)};"undefined"!=typeof ko&&ko.observable&&e(jQuery,ko,_),"undefined"!=typeof define&&define.amd&&define(["jquery","knockout","_"],e)})();