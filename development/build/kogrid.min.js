/*
kogrid 0.1.6 - created by Miguel Ludert
https://github.com/thinkingsites/kogrid

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

!function(a){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?a(require("knockout"),require("jquery"),require("lodash"),exports):"function"==typeof define&&define.amd?define(["knockout","jquery","lodash","exports"],a):a(ko,$,_,{})}(function(a,b,c){if(void 0===typeof a)throw"Knockout is required, please ensure it is loaded before loading this validation plug-in";if(void 0===typeof b)throw"jQuery is required, please ensure it is loaded before loading this validation plug-in";if(void 0===typeof c)throw"LoDash is required, please ensure it is loaded before loading this validation plug-in";var d=c.debounce,e=a.isObservable,f=a.observable,g=a.observableArray,h=a.computed,i=c.extend,j=window,k=c.each,l=c.isFunction,m=c.isNumber,n=c.isString,o=c.map,p=c.find,q=a.utils.unwrapObservable,r=a.bindingHandlers,s=function(a,b){var d=a[b];return c.isFunction(d)&&(d=d.apply(void 0,Array.prototype.slice.call(arguments,2))),d},t=a.applyBindingAccessorsToNode||function(b,d,e){var f={};return c.each(d,function(a,b){f[b]=a()}),a.applyBindingsToNode(b,f,e)},u=function(a){return c.isString(a)&&document.getElementById(a)||c.isElement(a)},v=function(){},w=function(a){return function(){return this.value}.bind({value:a})},x=function(a){return e(a)?a:f(a)},y=function(a){return e(a)?a.peek():a},z=f({h:j.screen.height,w:j.screen.width}),A=function(){return"ko-grid-"+Math.round(Math.random()*Math.pow(10,10)).toString()},B=function(a,c,d){var e=I[c],f=b(e.template).appendTo(a);return e.cssClass&&f.addClass(e.cssClass),d&&f.css(d),f},C=function(a){if(a.addjQueryUiSortingIcons!==!1){var b=["ui-icon","ui-icon-triangle-2-n-s","ui-icon-triangle-1-n","ui-icon ui-icon-triangle-1-s"],d=a.addjQueryUiSortingIcons===!0,e=j.jQuery&&j.jQuery.ui||c.any(document.styleSheets,function(a){return c(a.rules).filter(function(a){return a.selectorText}).map(function(a){return a.selectorText.slice(1)}).intersection(b).value().length==b.length});(d||e)&&(a.sorting.noSortClass+=[void 0,b[0],b[1]].join(" "),a.sorting.ascendingClass+=[void 0,b[0],b[2]].join(" "),a.sorting.descendingClass+=[void 0,b[0],b[3]].join(" "))}},D=function(a,c){var d,e=b(a),c=parseInt(c)||c,f="shrink"===c,g=b("."+I.scrollContainer.cssClass,e),h=b("."+I.headContainer.cssClass,e).outerHeight(),i=b("."+I.pager.cssClass,e).outerHeight();e.toggleClass("ko-grid-shrink-to-fit",f),d=f?"auto":"auto"!==c&&"inherit"!==c?e.innerHeight()-h-i:c,g.css("height",d)},E=function(a,b){return(a.pageIndex.peek()-1)*a.pageSize.peek()+b},F=function(a,b,c){return{$columnValue:w(b),$rowIndex:w(c),$recordIndex:w(E(a,c))}},G=function(j,k,r){if(!j.url&&!j.rows)throw"kogrid: Either 'url' or 'rows' must be defined in the grid options";var t,u=b.extend(!0,this,H,j),w=g(),A=g();_rows=x(u.rows||[]),_pageIndex=x(u.pageIndex),u.templates={},u.element=k,u.classes=r,u.height=x(u.height),u.total=x(u.total||0),u.pageSize=x(u.pageSize),u.columns=a.computed({read:function(){var a=this();return u.sorting.sortableByDefault&&c.each(a,function(a){a.sortable=a.sortable!==!1?!0:!1}),a},write:function(a){this(a)},owner:x(u.columns)}),u.pageIndex=a.computed({read:function(){var a=_pageIndex();return _rows().length?a:0},write:function(a){_pageIndex(a)}}),u.url=x(u.url),u.rowClick=function(a,b){var d=this;return c.isFunction(d)?d.call(a,a,b):!0}.bind(u.rowClick),u.isString=n,u.any=h(function(){return!!u.total()}),u.none=h(function(){return!u.total()}),u.noneText=f(s(u.messages,"initial")),u.pagerVisible=a.computed(function(){return!!q(u.pager)}),u.resizeHeaders=function(){var a,c,d=b("."+u.classes.head,u.element),e=b("."+u.classes.row+":first ."+u.classes.cell,u.element).map(function(){var a=b(this);return{left:a.position().left,width:a.width()}});if(d.length!=e.length)return void d.css({position:"relative",top:0,left:"auto",width:Math.floor(100/d.length)+"%"}).width();d.first().parent().height(d.first().height());for(var f=0;f<d.length;f++)a=d.eq(f),c=e[f],a.css({position:"absolute",top:0,left:c.left-1,width:c.width})},u.afterRender=d(function(){u.resizeHeaders(),D(u.element,u.height.peek()),l(u.done)&&u.done(k,u.utils)},10),u.sort=function(){if(this.sortable===!0){var a=this,b=p(w.peek(),function(b){return b.key===a.key})||{key:a.key,direction:a.direction},d=c.filter(w.peek(),function(b){return b.key!=a.key});b.direction=b.direction===u.sorting.asc?u.sorting.desc:u.sorting.asc,u.sorting.allowMultiSort?(d.unshift(b),w(d)):w([b]),e(a.direction)?a.direction(b.direction):a.direction=b.direction,l(u.refresh)&&u.refresh()}},u.sortClass=function(a){var b=p(w(),function(b){return b.key===a.key});if(b){if(b.direction==u.sorting.asc)return u.sorting.ascendingClass;if(b.direction==u.sorting.desc)return u.sorting.descendingClass}return u.sorting.noSortClass},e(u.total)||(u.total=h({read:function(){return m(t)?t:e(_rows)?_rows.peek().length:c.isArray(_rows)?_rows.length:void 0},write:function(a){t=a}})),u.totalPages=h(function(){var a=u.total(),b=u.pageSize();return m(a)&&m(b)&&a?Math.ceil(a/b):0}),u.first=function(){_pageIndex(1)},u.previous=function(){var a=_pageIndex.peek();_pageIndex(Math.max(1,a-1))},u.next=function(){var a=_pageIndex.peek(),b=u.totalPages.peek();_pageIndex(Math.min(b,a+1))},u.last=function(){_pageIndex(u.totalPages.peek())},u.goToPage=function(){var a=parseInt(u.goToPageText.peek());m(a)&&a>=1&&a<=u.totalPages.peek()?_pageIndex(a):u.goToPageText("")},u.isPreviousEnabled=function(){return _rows().length>0&&1<_pageIndex()},u.isNextEnabled=function(){return _rows().length>0&&_pageIndex()<u.totalPages()},u.isGoToPageEnabled=function(){return _rows().length>0},u.goToPageText=f(),z.subscribe(u.resizeHeaders),function B(a){c.forOwn(a,function(a){var b=a;e(b)&&(b.subscribe(function(){u.afterRender()}),b=b()),c.isObject(b)&&B(b)})}(j),n(u.url.peek())?(u.rows=_rows,u.refresh=function(){l(u.loading)&&u.loading(u.element,u.rows.peek()),u.noneText(s(u.messages,"loading"));var d=_pageIndex.peek(),e=u.pageSize.peek(),f=m(e)?{pageIndex:d,pageSize:e}:{pageIndex:1},g=y(u.data),h={};return h[u.sorting.sortColumn]=o(w.peek(),function(a){return a.key}),h[u.sorting.sortDirection]=o(w.peek(),function(a){return a.direction}),u.sorting.allowMultiSort||(h[u.sorting.sortColumn]=h[u.sorting.sortColumn][0],h[u.sorting.sortDirection]=h[u.sorting.sortDirection][0]),g=a.toJS(g),u.cleanPostData!==!1&&c.each(g,function(a,b){(c.isUndefined(a)||c.isNull(a))&&(g[b]="")}),b.ajax({url:u.url.peek(),data:i(f,h,u.sanitize(g)),type:u.type||"get",dataType:u.dataType||"json",async:u.async}).done(function(a,b,c){var d=u.getRows(a,c),e=u.getTotal(a,c);u.rows(l(u.map)?o(d,u.map):d),u.total(e||d.length||0),u.noneText(u.noRows||s(u.messages,"noRows"))}).fail(function(a){u.noneText(s(u.messages,"error",a))}).always(function(){l(u.loaded)&&u.loaded(u.element,u.rows.peek())}).promise()},e(u.data)&&u.data.subscribe(u.refresh),u.url.subscribe(u.refresh),u.autoLoad&&u.refresh()):(u.refresh=v,u.rows=h({read:function(){var a=_rows(),b=u.pageSize(),c=(_pageIndex()-1)*b;return l(u.map)&&(a=o(a,u.map)),a.slice(c,c+b)},write:function(a){_rows(a)}}),u.total(_rows.peek().length),_rows.subscribe(function(){u.total(_rows.peek().length)})),u.clear=function(){u.rows([]),u.total(0),u.noneText(s(u.messages,"initial"))},_pageIndex.subscribe(u.refresh),u.pageSize.subscribe(function(){var a=u.totalPages.peek(),b=_pageIndex.peek();b>a?_pageIndex(a):u.refresh()}),u.height.subscribe(function(a){D(u.element,a)}),u.isColumnVisible=function(a){return a=a||this,e(a.visible)||c.isBoolean(a.visible)?a.visible:!0},u.cb={visible:function(){return!c.isEmpty(u.checkbox)},value:function(a){var b=a.$index(),a=i({},a,F(u,-1,b));return u.id?a.$data[u.id]:a.$recordIndex},change:function(a,d){var e=!0,f=u.checkbox.change,g=this.$index(),h=i({},this,F(u,-1,g));if(b(d.target).is(":checked")?A.push({i:h.$recordIndex(),v:h.$data}):A.remove(function(a){return a.i==h.$recordIndex()}),!u.checkbox.multiple){var j=c.filter(A.peek(),function(a){return a.i==h.$recordIndex()});A(j)}return l(f)&&(e=f.call(h.$data,h.$data,d,h)),e===!1?!1:!0},checked:function(a){var b;return b=u.id?function(b){return b.v[u.id]==a.$data[u.id]}:function(b){return b.i==E(u,a.$index())},c.find(A(),b)},rows:A},this.utils={fixHeaders:u.resizeHeaders,refresh:u.refresh,clear:u.clear,goToPage:function(a){_pageIndex(a)},getChecked:function(a){var b=c.sortBy(u.cb.rows(),"i");return o(b,function(b){return a?b.i:b.v})},checkedAll:function(){u.cb.rows(c.times(u.total()))},uncheckAll:function(){return u.cb.rows.removeAll()},element:function(){return k}},e(u.checkedRows)&&A.subscribe(function(){var a=c.sortBy(A(),"i"),b=o(a,function(a){return a.v});u.checkedRows(b)})},H={pageSize:25,pageSizeOptions:[10,25,50,100,200,"All"],pageIndex:1,pager:!0,height:"auto",autoLoad:!0,async:!0,loading:function(a){b("table",a).css({opacity:.5})},loaded:function(a){b("table",a).css({opacity:1})},messages:{initial:"",noRows:"No rows available",loading:"Loading..."},checkbox:!1,sorting:{allowMultiSort:!1,sortColumn:"sortColumn",sortableByDefault:!1,sortDirection:"sortDirection",asc:"asc",desc:"desc",noSortClass:"ko-grid-sort-none",ascendingClass:"ko-grid-sort-asc",descendingClass:"ko-grid-sort-desc",addjQueryUiSortingIcons:"auto"},getRows:function(a){return a.rows},getTotal:function(a){return a.total},sanitize:function(a){return a}},I={headContainer:{template:"<div></div>",cssClass:"ko-grid-head-container"},head:{template:"<!-- ko foreach : { data : columns, afterRender : $root.afterRender } --><div data-bind='visible : $root.isColumnVisible($data), click : $root.sort, css : { \"ko-grid-is-sortable\" : $data.sortable } '><span data-bind='text : ($root.isString($data) ? $data : $data.title)'></span></div><!-- /ko -->",cssClass:"ko-grid-head"},sortIcon:{template:"<span type='button' data-bind='visible: $data.sortable,  css : $root.sortClass($data) '>Sort</span>",cssClass:"ko-grid-sort-icon"},scrollContainer:{template:"<div></div>",cssClass:"ko-grid-scroll-container"},table:{template:"<table cellspacing='0' cellpadding='0' data-bind='visible : any'><tbody data-bind='foreach : { data : rows, afterRender : $root.afterRender }'></tbody></table>",cssClass:"ko-grid-table"},row:{template:'<tr data-bind=\'click : $root.rowClick, css : $index()%2 ? $root.classes.row + "-even" : $root.classes.row + "-odd" \'></tr>',cssClass:"ko-grid-row"},cell:{template:"<!-- ko foreach : $root.columns --><td data-bind='kogrid$cell:$data'></td><!-- /ko -->",cssClass:"ko-grid-cell"},pager:{template:"<div data-bind='visible : pagerVisible'></div>",cssClass:"ko-grid-pager"},first:{template:"<button type='button' data-bind='click : first, enable : isPreviousEnabled' title='First'>&lt;&lt; First</button>",cssClass:"ko-grid-first"},previous:{template:"<button type='button' data-bind='click : previous, enable : isPreviousEnabled' title='Previous'>&lt; Previous</button>",cssClass:"ko-grid-previous"},next:{template:"<button type='button' data-bind='click : next, enable : isNextEnabled' title='Next'>Next &gt;</button>",cssClass:"ko-grid-next"},last:{template:"<button type='button' data-bind='click : last, enable : isNextEnabled' title='Last'>Last  &gt;&gt;</button>",cssClass:"ko-grid-last"},refresh:{template:"<button type='button' data-bind='click : refresh' title='Refresh'>Refresh</button>",cssClass:"ko-grid-refresh"},pageSize:{template:"<select data-bind='options : pageSizeOptions, value : pageSize'></select>",cssClass:"ko-grid-page-size"},goToPage:{template:"<div><input type='text' data-bind='value : goToPageText, enable : isGoToPageEnabled'><button data-bind='click : goToPage, enable : isGoToPageEnabled'>Go</button></div>",cssClass:"ko-grid-go-to-page"},pagingText:{template:"<div>Page <span data-bind='text:pageIndex'></span> of <span data-bind='text: totalPages'></span></div>",cssClass:"ko-grid-paging-text"},totalText:{template:"<div><span data-bind='text:total'></span> records</div>",cssClass:"ko-grid-total-text"},noRows:{template:"<div data-bind='visible : none,html: noneText'></div>",cssClass:"ko-grid-no-rows"},checkbox:{template:"<td style='text-align:center' data-bind='visible : $root.cb.visible'><input type='checkbox' data-bind='checked : $root.cb.checked($context), value: $root.cb.value($context), event : { click : $root.cb.change.bind($context) }'/></td>",cssClass:"ko-grid-checkbox"}};r.kogrid$cell={init:function(a,b,d,e,f){var g,h=f.$root,j=f.$parent,k=f.$data,m=h.templates[k.template],o={visible:h.isColumnVisible.bind(k)};if(m)g=i({},k.data,j),o.template=w({name:m,data:g});else{var p=n(k)?k:k.key,q=j[p],g=l(q)?q():q;c.isFunction(k.format)&&(g=k.format(g)),o.text=w(g)}k.style&&(o.style=w(k.style)),k.style&&(o.css=w(k.css));var r=F(f.$root,f.$parentContext.$index(),f.$index());try{var s=f.extend(r);t(a,o,s)}catch(u){throw u._result=g,u}return{controlsDescendantBindings:!0}}},r.kogrid={init:function(d,f){return b(function(){{var g,h=function(){var a={};return k(I,function(b,c){a[c]=b.cssClass}),a}(),j=f(),l=new G(j,d,h),m=e(l.columns)?l.columns.peek():l.columns,o=b(d).addClass("ko-grid-main"),p=B(o,"headContainer",{position:"relative"}),r=(c.isEmpty(l.checkbox)?void 0:b("<div></div>").addClass(I.head.cssClass).appendTo(p),B(p,"head")),s=(B(r,"sortIcon"),B(o,"scrollContainer")),t=B(s,"table",{position:"relative"}),w=B(t,"row");c.isEmpty(l.checkbox)?void 0:B(w,"checkbox").addClass(I.cell.cssClass),B(w,"cell"),B(s,"noRows")}g=B(o,"pager"),l.refresh!==v&&B(g,"refresh"),B(g,"first"),B(g,"previous"),B(g,"pagingText"),B(g,"next"),B(g,"last"),B(g,"pageSize"),B(g,"goToPage"),B(g,"totalText");var x=function(a){if(u(a))c.isString(a)&&(l.templates[a]=a);else{var e=A();l.templates[a]=e,b("<script type='text/html' id='"+e+"'>"+q(a)+"</script>").appendTo(d)}};c(m).filter(function(a){return n(a.template)}).each(function(a){x(a.template)}),C(l),a.applyBindingsToDescendants(l,d),j.utils=i(j.utils||{},l.utils),jQuery&&jQuery.ui&&jQuery.ui.tabs&&b(d).parents(".ui-tabs.ui-widget").on("tabsactivate",function(){l.utils.fixHeaders()})}),{controlsDescendantBindings:!0}},options:H,templates:I},b(function(){b(j).on("resize",d(function(){var a={h:b(j).height(),w:b(j).width()},c=z.peek();(a.h!==c.h||a.w!==c.w)&&z(a)},100))})});