/*
kogrid - created by Miguel Ludert
https://github.com/thinkingsites/kogrid

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
"use strict";(function(){var e=function(e,t){var n=_.debounce,i=t.isObservable,o=(t.bindingHanders,t.observable),s=t.observableArray,a=t.computed,r=t.applyBindingAccessorsToNode||function(e,n,i){var o={};return _.each(n,function(e,t){o[t]=e()}),t.applyBindingsToNode(e,o,i)},c=function(e){return _.isString(e)&&document.getElementById(e)||_.isElement(e)},d=_.extend,l=window,u=_.each,g=_.isFunction,p=_.isNumber,f=_.isString,h=_.map,b=_.find,k=function(){},v=function(e){return function(){return this}.bind(e)},x=function(e){return i(e)?e:o(e)},m=function(e){return i(e)?e():e},w=function(e){return i(e)?e.peek():e},C=o({h:e(l).height(),w:e(l).width()}),y=function(){return"ko-grid-"+(""+Math.round(Math.random()*Math.pow(10,10)))},$=function(t,n,i){var o=j[n],s=e(o.template).appendTo(t);return o.cssClass&&s.addClass(o.cssClass),i&&s.css(i),s},I=function(t){if(t.addjQueryUiSortingIcons!==!1){var n=["ui-icon","ui-icon-triangle-2-n-s","ui-icon-triangle-1-n","ui-icon ui-icon-triangle-1-s"],i=t.addjQueryUiSortingIcons===!0,o=e.ui||_.any(document.styleSheets,function(e){return _(e.rules).filter(function(e){return e.selectorText}).map(function(e){return e.selectorText.slice(1)}).intersection(n).value().length==n.length});(i||o)&&(t.sorting.noSortClass+=[void 0,n[0],n[1]].join(" "),t.sorting.ascendingClass+=[void 0,n[0],n[2]].join(" "),t.sorting.descendingClass+=[void 0,n[0],n[3]].join(" "))}},S=function(t,n){var i=e(t),n=parseInt(n)||n,o=e("."+j.scrollContainer.cssClass,i),s=e("."+j.headContainer.cssClass,i).outerHeight(),a=e("."+j.pager.cssClass,i).outerHeight();i.css("height",n),"auto"!==n&&"inherit"!==n?o.css("height",i.innerHeight()-s-a):o.css("height",n)},T=function(e,t){return(e.pageIndex.peek()-1)*e.pageSize.peek()+t},z=function(e,t,n){return{$columnValue:v(t),$rowIndex:v(n),$recordIndex:v(T(e,n))}},P=function(t,r,c){var l,u=this,v=s(),y=s();if(d(u,R,t),u.templates={},u.element=r,u.classes=c,u.rows=x(u.rows),u.height=x(u.height),u.total=x(u.total),u.pageSize=x(u.pageSize),u.pageIndex=x(u.pageIndex),u.url=x(u.url),u.rowClick=function(e,t){var n=this;return n?n.call(e,e,t):!0}.bind(u.rowClick),u.isString=f,u.any=a(function(){var e=m(u.rows);return!(_.isUndefined(e)||0==e.length)}),u.none=a(function(){var e=m(u.rows);return _.isUndefined(e)||0==e.length}),u.resizeHeaders=function(){var t,n,i=e("."+u.classes.head,u.element),o=e("."+u.classes.row+":first ."+u.classes.cell,u.element).map(function(){var t=e(this);return{left:t.position().left,width:t.width()}});if(i.length!=o.length)return i.css({position:"relative",top:0,left:"auto",width:Math.floor(100/i.length)+"%"}).width(),void 0;i.first().parent().height(i.first().height());for(var s=0;i.length>s;s++)t=i.eq(s),n=o[s],t.css({position:"absolute",top:0,left:n.left-1,width:n.width})},u.afterRender=n(function(){u.resizeHeaders(),S(u.element,u.height.peek()),g(u.done)&&u.done(r)},10),u.sort=function(){if(this.sortable===!0){var e=this,t=b(v.peek(),function(t){return t.key===e.key})||{key:e.key,direction:e.direction},n=_.filter(v.peek(),function(t){return t.key!=e.key});t.direction=t.direction===u.sorting.asc?u.sorting.desc:u.sorting.asc,u.sorting.allowMultiSort?(n.unshift(t),v(n)):v([t]),i(e.direction)?e.direction(t.direction):e.direction=t.direction,g(u.refresh)?u.refresh():i(u.rows)}},u.sortClass=function(e){var t=b(v(),function(t){return t.key===e.key});if(t){if(t.direction==u.sorting.asc)return u.sorting.ascendingClass;if(t.direction==u.sorting.desc)return u.sorting.descendingClass}return u.sorting.noSortClass},i(u.total)||(u.total=a({read:function(){return p(l)?l:i(u.rows)?u.rows.peek().length:_.isArray(u.rows)?u.rows.length:void 0},write:function(e){l=e}})),u.totalPages=a(function(){var e=u.total(),t=u.pageSize();return p(e)&&p(t)?Math.ceil(e/t):1}),u.first=function(){u.pageIndex(1)},u.previous=function(){var e=u.pageIndex.peek();u.pageIndex(Math.max(1,e-1))},u.next=function(){var e=u.pageIndex.peek(),t=u.totalPages.peek();u.pageIndex(Math.min(t,e+1))},u.last=function(){u.pageIndex(u.totalPages.peek())},u.goToPage=function(){var e=parseInt(u.goToPageText.peek());p(e)&&e>=1&&u.totalPages.peek()>=e?u.pageIndex(e):u.goToPageText("")},u.goToPageText=o(),C.subscribe(u.resizeHeaders),function $(e){_.forOwn(e,function(e){var t=e;i(t)&&(t.subscribe(function(){u.afterRender()}),t=t()),_.isObject(t)&&$(t)})}(t),f(u.url.peek()))u.rows=x(u.rows),u.refresh=function(){g(u.loading)&&u.loading(u.element,u.rows.peek());var t=u.pageIndex.peek(),n=u.pageSize.peek(),i=p(n)?{pageIndex:t,pageSize:n}:{pageIndex:1},o=w(u.data),s={};return s[u.sorting.sortColumn]=h(v.peek(),function(e){return e.key}),s[u.sorting.sortDirection]=h(v.peek(),function(e){return e.direction}),e.ajax({url:u.url.peek(),data:d(i,s,o),type:u.type||"get",dataType:u.dataType||"json"}).done(function(e){u.rows(g(u.map)?h(e.rows,u.map):e.rows),u.total(e.total||e.rows.length)}).always(function(){g(u.loaded)&&u.loaded(u.element,u.rows.peek())}).promise()},i(u.data)&&u.data.subscribe(u.refresh),u.url.subscribe(u.refresh),u.refresh();else{u.refresh=k;var I=x(g(u.map)?h(m(u.rows),u.map):u.rows);u.rows=a({read:function(){var e=u.pageSize(),t=(u.pageIndex()-1)*e;return I().slice(t,t+e)},write:function(e){I(g(u.map)?h(m(e),u.map):e)}}),u.total(I.peek().length)}u.pageIndex.subscribe(u.refresh),u.pageSize.subscribe(function(){var e=u.totalPages.peek(),t=u.pageIndex.peek();t>e?u.pageIndex(e):u.refresh()}),u.height.subscribe(function(e){S(u.element,e)}),u.isColumnVisible=function(e){return e=e||this,i(e.visible)||_.isBoolean(e.visible)?e.visible:!0},u.cb={visible:function(){return!_.isEmpty(u.checkbox)},value:function(e){var t=e.$index(),e=d({},e,z(u,-1,t));return u.checkbox.id?e.$data[u.checkbox.id]:e.$recordIndex},change:function(t,n){var i=!0,o=u.checkbox.change,s=this.$index(),a=d({},this,z(u,-1,s));if(e(n.target).is(":checked")?y.push({i:a.$recordIndex(),v:a.$data}):y.remove(function(e){return e.i==a.$recordIndex()}),!u.checkbox.multiple){var r=_.filter(y.peek(),function(e){return e.i==a.$recordIndex()});y(r)}return g(o)&&(i=o.call(a.$data,a.$data,n,a)),i===!1?!1:!0},checked:function(e){return _.find(y(),function(t){return t.i==T(u,e)})},rows:y},i(u.checkedRows)&&y.subscribe(function(){var e=_.sortBy(y(),"i"),t=h(e,function(e){return e.v});u.checkedRows(t)})},R={pageSize:25,pageSizeOptions:[10,25,50,100,200,"All"],pageIndex:1,pager:!0,height:"auto",loading:function(t){e("table",t).css({opacity:.5})},loaded:function(t){e("table",t).css({opacity:1})},noRows:"No rows available",checkbox:!1,sorting:{allowMultiSort:!1,sortColumn:"sortColumn",sortDirection:"sortDirection",asc:"asc",desc:"desc",noSortClass:"ko-grid-sort-none",ascendingClass:"ko-grid-sort-asc",descendingClass:"ko-grid-sort-desc",addjQueryUiSortingIcons:"auto"}},j={headContainer:{template:"<div></div>",cssClass:"ko-grid-head-container"},head:{template:"<!-- ko foreach : { data : columns, afterRender : $root.afterRender } --><div data-bind='visible : $root.isColumnVisible($data), click : $root.sort, css : { \"ko-grid-is-sortable\" : $data.sortable } '><span data-bind='text : ($root.isString($data) ? $data : $data.title)'></span></div><!-- /ko -->",cssClass:"ko-grid-head"},sortIcon:{template:"<span type='button' data-bind='visible: $data.sortable,  css : $root.sortClass($data) '>Sort</span>",cssClass:"ko-grid-sort-icon"},scrollContainer:{template:"<div></div>",cssClass:"ko-grid-scroll-container"},table:{template:"<table cellspacing='0' cellpadding='0' data-bind='visible : any'><tbody data-bind='foreach : { data : rows, afterRender : $root.afterRender }'></tbody></table>",cssClass:"ko-grid-table"},row:{template:'<tr data-bind=\'click : $root.rowClick, css : $index()%2 ? $root.classes.row + "-even" : $root.classes.row + "-odd" \'></tr>',cssClass:"ko-grid-row"},cell:{template:"<!-- ko foreach : $root.columns --><td data-bind='kogrid$cell:$data'></td><!-- /ko -->",cssClass:"ko-grid-cell"},pager:{template:"<div></div>",cssClass:"ko-grid-pager"},first:{template:"<button type='button' data-bind='click : first, disable : pageIndex() == 1' title='First'>&lt;&lt; First</button>",cssClass:"ko-grid-first"},previous:{template:"<button type='button' data-bind='click : previous, disable : pageIndex() == 1' title='Previous'>&lt; Previous</button>",cssClass:"ko-grid-previous"},next:{template:"<button type='button' data-bind='click : next, disable : pageIndex() == totalPages()' title='Next'>Next &gt;</button>",cssClass:"ko-grid-next"},last:{template:"<button type='button' data-bind='click : last, disable : pageIndex() == totalPages()' title='Last'>Last  &gt;&gt;</button>",cssClass:"ko-grid-last"},refresh:{template:"<button type='button' data-bind='click : refresh' title='Refresh'>Refresh</button>",cssClass:"ko-grid-refresh"},pageSize:{template:"<select data-bind='options : pageSizeOptions, value : pageSize'></select>",cssClass:"ko-grid-page-size"},goToPage:{template:"<div><input type='text' data-bind='value : goToPageText'><button data-bind='click : goToPage'>Go</button></div>",cssClass:"ko-grid-go-to-page"},pagingText:{template:"<div>Page <span data-bind='text:pageIndex'></span> of <span data-bind='text: totalPages'></span></div>",cssClass:"ko-grid-paging-text"},totalText:{template:"<div><span data-bind='text:total'></span> records</div>",cssClass:"ko-grid-total-text"},noRows:{template:"<div data-bind='visible : none,html: noRows'></div>",cssClass:"ko-grid-no-rows"},checkbox:{template:"<td style='text-align:center' data-bind='visible : $root.cb.visible'><input type='checkbox' data-bind='checked : $root.cb.checked($index()), value: $root.cb.value($context), event : { click : $root.cb.change.bind($context) }'/></td>",cssClass:"ko-grid-checkbox"}};e(function(){e(l).on("resize",n(function(){var t={h:e(l).height(),w:e(l).width()},n=C.peek();(t.h!==n.h||t.w!==n.w)&&C(t)},100))});var H={kogrid$cell:{init:function(e,t,n,i,o){var s=o.$root,a=o.$parent,c=o.$data,l=s.templates[c.template],u={visible:s.isColumnVisible.bind(c)};if(l)u.template=v({name:l,data:d({},c.data,a)});else{var p,h=f(c)?c:c.key,b=a[h],p=g(b)?b():b;u.text=v(p)}d(u,{style:v(c.style),css:v(c.css)});var k=z(o.$root,o.$parentContext.$index(),o.$index());return r(e,u,o.extend(k)),{controlsDescendantBindings:!0}}},kogrid:{init:function(n,o){return e(function(){var s,a=function(){var e={};return u(j,function(t,n){e[n]=t.cssClass}),e}(),r=o(),l=new P(r,n,a),g=i(l.columns)?l.columns.peek():l.columns,p=e(n).addClass("ko-grid-main").css({height:l.height.peek()}),b=$(p,"headContainer",{position:"relative"}),v=(_.isEmpty(l.checkbox)?void 0:e("<div></div>").addClass(j.head.cssClass).appendTo(b),$(b,"head")),x=($(v,"sortIcon"),$(p,"scrollContainer")),w=$(x,"table",{position:"relative"}),C=$(w,"row");_.isEmpty(l.checkbox)?void 0:$(C,"checkbox").addClass(j.cell.cssClass),$(C,"cell"),$(x,"noRows"),l.pager&&(s=$(p,"pager"),l.refresh!==k&&$(s,"refresh"),$(s,"first"),$(s,"previous"),$(s,"pagingText"),$(s,"next"),$(s,"last"),$(s,"pageSize"),$(s,"goToPage"),$(s,"totalText"));var S=function(t){if(!c(t)){var i=y();l.templates[t]=i,e("<script type='text/html' id='"+i+"'>"+m(t)+"</script>").appendTo(n)}};_(g).filter(function(e){return f(e.template)}).each(function(e){S(e.template)}),I(l),t.applyBindingsToDescendants(l,n),r.utils=d({},r.utils,{fixHeaders:l.resizeHeaders,refresh:l.refresh,goToPage:function(e){l.pageIndex(e)},getChecked:function(e){var t=_.sortBy(l.cb.rows(),"i");return h(t,function(t){return e?t.i:t.v})},checkedAll:function(){l.cb.rows(_.times(l.total()))},uncheckAll:function(){return l.cb.rows.removeAll()},element:function(){return n}})}),{controlsDescendantBindings:!0}},options:R,templates:j}};d(t.bindingHandlers,H)};"undefined"!=typeof ko&&ko.observable&&e(jQuery,ko,_),"undefined"!=typeof define&&define.amd&&define(["jquery","knockout","_"],e)})();