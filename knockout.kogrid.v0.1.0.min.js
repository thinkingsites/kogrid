/*
kogrid - created by Miguel Ludert
https://github.com/thinkingsites/kogrid

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
"use strict";(function(){var e=function(e,t,s){var i=function(){},n=function(e){return t.isObservable(e)?e:t.observable(e)},a=function(e){return t.isObservable(e)?e():e},o=function(e){return t.isObservable(e)?e.peek():e},r=t.observable({h:e(window).height(),w:e(window).width()}),l=function(){return"ko-grid-"+(""+Math.round(Math.random()*Math.pow(10,10)))},d=function(t,s,i){var n=f[s],a=e(n.template).appendTo(t);return n.cssClass&&a.addClass(n.cssClass),i&&a.css(i),a},c=function(t){if(t.addjQueryUiSortingIcons!==!1){var i=["ui-icon","ui-icon-triangle-2-n-s","ui-icon-triangle-1-n","ui-icon ui-icon-triangle-1-s"],n=t.addjQueryUiSortingIcons===!0,a=e.ui||s.any(document.styleSheets,function(e){return s(e.rules).map(function(e){return e.selectorText.slice(1)}).intersection(jquiStyles).value().length==i.length});(n||a)&&(t.sorting.noSortClass+=[void 0,i[0],i[1]].join(" "),t.sorting.ascendingClass+=[void 0,i[0],i[2]].join(" "),t.sorting.descendingClass+=[void 0,i[0],i[3]].join(" "))}},u=function(t,s){var i=e(t),s=parseInt(s)||s,n=e("."+f.scrollContainer.cssClass,i),a=e("."+f.headContainer.cssClass,i).outerHeight(),o=e("."+f.pager.cssClass,i).outerHeight();i.css("height",s),"auto"!==s&&"inherit"!==s?n.css("height",i.innerHeight()-a-o):n.css("height",s)},p=function(l,d,c){var p,f=this,h=t.observableArray();if(e.extend(f,b,l),f.element=d,f.templates={},f.classes=c,f.rows=n(f.rows),f.height=n(f.height),f.total=n(f.total),f.pageSize=n(f.pageSize),f.pageIndex=n(f.pageIndex),f.url=n(f.url),f.any=function(){var e=a(f.rows);return!(s.isUndefined(e)||0==e.length)},f.resizeHeaders=function(){var t,s,i=e("."+f.classes.head,f.element),n=e("."+f.classes.row+":first ."+f.classes.cell,f.element).map(function(){var t=e(this);return{left:t.position().left,width:t.width()}});if(i.length!=n.length)return i.css({position:"relative",top:0,left:"auto",width:Math.floor(100/i.length)+"%"}).width(),void 0;i.first().parent().height(i.first().height());for(var a=0;i.length>a;a++)t=i.eq(a),s=n[a],t.css({position:"absolute",top:0,left:s.left-1,width:s.width})},f.afterRender=s.debounce(function(){f.resizeHeaders(),u(f.element,f.height.peek()),s.isFunction(f.done)&&f.done(d)},100),f.isColumnVisible=function(e){return t.isObservable(e.visible)?e.visible():s.isBoolean(e.visible)?e.visible:!0},f.sort=function(){if(this.sortable===!0){var e=this,i=s.find(h.peek(),function(t){return t.key===e.key})||{key:e.key,direction:e.direction},n=s.filter(h.peek(),function(t){return t.key!=e.key});i.direction=i.direction===f.sorting.asc?f.sorting.desc:f.sorting.asc,f.sorting.allowMultiSort?(n.unshift(i),h(n)):h([i]),t.isObservable(e.direction)?e.direction(i.direction):e.direction=i.direction,s.isFunction(f.refresh)?f.refresh():t.isObservable(f.rows)}},f.sortClass=function(e){var t=s.find(h(),function(t){return t.key===e.key});if(t){if(t.direction==f.sorting.asc)return f.sorting.ascendingClass;if(t.direction==f.sorting.desc)return f.sorting.descendingClass}return f.sorting.noSortClass},f.selectCellTemplate=function(e,t){var i,n=f.templates[e.template];if(n)i={name:n,data:s.extend({},e.data,t)};else var a,o=s.isString(e)?e:e.key,r=t[o],a=s.isFunction(r)?r():r,i={name:g,data:a};return i},t.isObservable(f.total)||(f.total=t.computed({read:function(){return s.isNumber(p)?p:t.isObservable(f.rows)?f.rows.peek().length:s.isArray(f.rows)?f.rows.length:void 0},write:function(e){p=e}})),f.totalPages=t.computed(function(){var e=f.total(),t=f.pageSize();return s.isNumber(e)&&s.isNumber(t)?Math.ceil(e/t):1}),f.first=function(){f.pageIndex(1)},f.previous=function(){var e=f.pageIndex.peek();f.pageIndex(Math.max(1,e-1))},f.next=function(){var e=f.pageIndex.peek(),t=f.totalPages.peek();f.pageIndex(Math.min(t,e+1))},f.last=function(){f.pageIndex(f.totalPages.peek())},f.goToPage=function(){var e=parseInt(f.goToPageText.peek());s.isNumber(e)&&e>=1&&f.totalPages.peek()>=e?f.pageIndex(e):f.goToPageText("")},f.goToPageText=t.observable(),r.subscribe(f.resizeHeaders),function v(e){s.forOwn(e,function(e){var i=e;t.isObservable(i)&&(i.subscribe(function(){f.afterRender()}),i=i()),s.isObject(i)&&v(i)})}(l),s.isString(f.url.peek()))f.rows=n(f.rows),f.refresh=function(){s.isFunction(f.loading)&&f.loading(f.element,f.rows.peek());var t=f.pageIndex.peek(),i=f.pageSize.peek(),n=s.isNumber(i)?{pageIndex:t,pageSize:i}:{pageIndex:1},a=o(f.data),r={};return r[f.sorting.sortColumn]=s.map(h.peek(),function(e){return e.key}),r[f.sorting.sortDirection]=s.map(h.peek(),function(e){return e.direction}),e.ajax({url:f.url.peek(),data:s.extend(n,r,a),type:f.type||"get",dataType:f.dataType||"json"}).done(function(e){f.rows(e.rows),f.total(e.total||e.rows.length)}).always(function(){s.isFunction(f.loaded)&&f.loaded(f.element,f.rows.peek())}).promise()},t.isObservable(f.data)&&f.data.subscribe(f.refresh),f.url.subscribe(f.refresh),f.refresh();else{f.refresh=i;var m=n(f.rows);f.rows=t.computed(function(){var e=f.pageSize(),t=(f.pageIndex()-1)*e;return m().slice(t,t+e)}),f.total(m.peek().length)}f.pageIndex.subscribe(f.refresh),f.pageSize.subscribe(function(){var e=f.totalPages.peek(),t=f.pageIndex.peek();t>e?f.pageIndex(e):f.refresh()}),f.height.subscribe(function(e){u(f.element,e)})},g="ko-grid-default-cell-template",b={pageSize:25,pageSizeOptions:[10,25,50,100,200,"All"],pageIndex:1,pager:!0,height:"auto",loading:function(t){e("table",t).css({opacity:.5})},loaded:function(t){e("table",t).css({opacity:1})},noRowsText:"No rows available",sorting:{allowMultiSort:!1,sortColumn:"sortColumn",sortDirection:"sortDirection",asc:"asc",desc:"desc",noSortClass:"ko-grid-sort-none",ascendingClass:"ko-grid-sort-asc",descendingClass:"ko-grid-sort-desc",addjQueryUiSortingIcons:"auto"}},f={headContainer:{template:"<div data-bind='foreach : { data : columns, afterRender : $root.afterRender }'></div>",cssClass:"ko-grid-head-container"},head:{template:"<div data-bind='visible : $root.isColumnVisible($data), click : $root.sort, css : { \"ko-grid-is-sortable\" : $data.sortable } '><span data-bind='text : (_.isString($data) ? $data : $data.title)'></span></div>",cssClass:"ko-grid-head"},sortIcon:{template:"<span type='button' data-bind='visible: $data.sortable,  css : $root.sortClass($data) '>Sort</span>",cssClass:"ko-grid-sort-icon"},scrollContainer:{template:"<div></div>",cssClass:"ko-grid-scroll-container"},table:{template:"<table cellspacing='0' cellpadding='0' data-bind='visible : any'><tbody data-bind='foreach : { data : rows, afterRender : $root.afterRender }'></tbody></table>",cssClass:"ko-grid-table"},row:{template:'<tr data-bind=\'foreach : $root.columns, css : $index()%2 ? $root.classes.row + "-even" : $root.classes.row + "-odd" \'></tr>',cssClass:"ko-grid-row"},cell:{template:"<td data-bind='template : $root.selectCellTemplate($data,$parent,$index,$context), visible : $root.isColumnVisible($data), style : $data.style, css : $data.css'></td>",cssClass:"ko-grid-cell"},pager:{template:"<div></div>",cssClass:"ko-grid-pager"},first:{template:"<button type='button' data-bind='click : first, disable : pageIndex() == 1' title='First'>&lt;&lt; First</button>",cssClass:"ko-grid-first"},previous:{template:"<button type='button' data-bind='click : previous, disable : pageIndex() == 1' title='Previous'>&lt; Previous</button>",cssClass:"ko-grid-previous"},next:{template:"<button type='button' data-bind='click : next, disable : pageIndex() == totalPages()' title='Next'>Next &gt;</button>",cssClass:"ko-grid-next"},last:{template:"<button type='button' data-bind='click : last, disable : pageIndex() == totalPages()' title='Last'>Last  &gt;&gt;</button>",cssClass:"ko-grid-last"},refresh:{template:"<button type='button' data-bind='click : refresh' title='Refresh'>Refresh</button>",cssClass:"ko-grid-refresh"},pageSize:{template:"<select data-bind='options : pageSizeOptions, value : pageSize'></select>",cssClass:"ko-grid-page-size"},goToPage:{template:"<div><input type='text' data-bind='value : goToPageText'><button data-bind='click : goToPage'>Go</button></div>",cssClass:"ko-grid-go-to-page"},pagingText:{template:"<div>Page <span data-bind='text:pageIndex'></span> of <span data-bind='text: totalPages'></span></div>",cssClass:"ko-grid-paging-text"},totalText:{template:"<div><span data-bind='text:total'></span> records</div>",cssClass:"ko-grid-total-text"},noRows:{template:"<div data-bind='visible : !any(), text : $root.noRowsText'></div>",cssClass:"ko-grid-no-rows"},cellContentTemplate:{template:"<script type='text/html' id='"+g+"'><!-- ko text: $data --><!-- /ko --></script>"}};e(function(){e(window).on("resize",s.debounce(function(){var t={h:e(window).height(),w:e(window).width()},s=r.peek();(t.h!==s.h||t.w!==s.w)&&r(t)},100))}),t.bindingHandlers.kogrid={init:function(n,a){return e(function(){var o,r=function(){var e={};return s.each(f,function(t,s){e[s]=t.cssClass}),e}(),u=a(),b=new p(u,n,r),h=t.isObservable(b.columns)?b.columns.peek():b.columns,v=e(n).addClass("ko-grid-main").css({height:b.height.peek()}),m=d(v,"headContainer",{position:"relative"}),k=d(m,"head"),x=(d(k,"sortIcon"),d(v,"scrollContainer")),w=d(x,"noRows"),w=d(x,"table",{position:"relative"}),C=d(w,"row");d(C,"cell");var y=e("body > #"+g);0==y.length&&e(f.cellContentTemplate.template).appendTo("body"),b.pager&&(o=d(v,"pager"),b.refresh!==i&&d(o,"refresh"),d(o,"first"),d(o,"previous"),d(o,"pagingText"),d(o,"next"),d(o,"last"),d(o,"pageSize"),d(o,"goToPage"),d(o,"totalText")),s(h).filter(function(e){return s.isString(e.template)}).each(function(t){if(!s.isElement(document.getElementById(t.template))){var i=l();b.templates[t.template]=i,e("<script type='text/html' id='"+i+"'>"+t.template+"</script>").appendTo(n)}}),c(b),t.applyBindingsToDescendants(b,n),u.utils=s.extend({},u.utils,{fixHeaders:b.resizeHeaders,refresh:b.refresh,goToPage:function(e){self.pageIndex(e)}})}),{controlsDescendantBindings:!0}},options:b,templates:f}};"undefined"!=typeof ko&&ko.observable&&e(jQuery,ko,_),"undefined"!=typeof define&&define.amd&&define(["jquery","knockout","_"],e)})();